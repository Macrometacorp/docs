!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PhotoniqEdsWs=t():e.PhotoniqEdsWs=t()}(this,(()=>(()=>{"use strict";var e={670:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Connection=t.EDSEventType=void 0;const r=s(721);var i;!function(e){e.Open="open",e.Close="close",e.ConnectionId="connection-id",e.ServerQueryError="server-query-error",e.ServerGlobalError="server-global-error",e.ClientQueryError="client-query-error",e.ClientGlobalError="client-global-error",e.Message="message"}(i||(t.EDSEventType=i={})),t.Connection=class{constructor(e,t){this.queriesToQuerySetsAndCallbacks=new Map,this.waitingMessages=[],this.config=e,this.globalListener=t}connect(){const e=`wss://${this.config.host}/api/es/v1/subscribe?type=collection&x-customer-id=${this.config.customerId}&apiKey=${this.config.apiKey}&fabric=${this.config.fabric}&filters=%7B%22action%22%3A%22remove%22%2C%22queries%22%3A%5B%22SELECT%20%2A%20FROM%20fake%22%5D%7D`;this.ws=new WebSocket(e);let t=this;this.ws.addEventListener("open",(function(e){var s;for(let e of t.waitingMessages)null===(s=t.ws)||void 0===s||s.send(e);t.waitingMessages=[];const r={type:i.Open,connection:t,data:e};t.handleGlobalListener(r),t.updatePingInterval()})),this.ws.addEventListener("message",(function(e){let s=e.data;if(t.id){let e=JSON.parse(s);if(e.error){let s=e.error;const r="Error parsing SQL query:";if(s.startsWith(r)){let n=s.substring(r.length,s.indexOf("ERROR")).trim();const o={type:i.ServerQueryError,connection:t,data:void 0,code:e.code,message:s,query:n};let l=t.queriesToQuerySetsAndCallbacks.get(n);l&&t.handleErrorListenerForMap(l,n,o),t.handleGlobalListener(o)}else{const r={type:i.ServerGlobalError,connection:t,data:void 0,code:e.code,message:s};t.handleGlobalListener(r)}}else for(let s in e){let r=t.queriesToQuerySetsAndCallbacks.get(s);if(r){let n=e[s];if(r.initial&&0===r.count)for(let e=0;e<n.length;e++)n[e]=t.convertInitialData(n[e]);else n=[n];r.count+=1;for(const[e,o]of r.qsCb)for(let e of o)try{let o={type:i.Message,connection:t,data:n,query:s,count:r.count,retrieve:r.initial};e(o),t.handleGlobalListener(o)}catch(e){let n=`Error while handling data for query: ${s}`;const o={type:i.ClientQueryError,connection:t,data:e,message:n,query:s};t.handleErrorListenerForMap(r,s,o),t.handleGlobalListener(o)}if(r.once){t.queriesToQuerySetsAndCallbacks.delete(s);const e=JSON.stringify({action:"remove",queries:[s]});t.send(e)}}}}else{const e=s.indexOf("x-photoniq-es");if(e>-1){const r=e+13+1,n=s.indexOf("\n",r);t.id=parseInt(s.substring(r,n).trim());const o={type:i.ConnectionId,connection:t,data:t.id};t.handleGlobalListener(o)}}})),this.ws.addEventListener("close",(function(e){t.pingIntervalId&&clearInterval(t.pingIntervalId);const s={type:i.Close,connection:t,data:e};t.handleGlobalListener(s)})),this.ws.addEventListener("error",(function(e){const s={type:i.ClientGlobalError,connection:t,data:e,message:"Client error"};t.handleGlobalListener(s)}))}send(e){var t;this.isConnected()?(null===(t=this.ws)||void 0===t||t.send(e),this.updatePingInterval()):this.waitingMessages.push(e)}querySet(){return new r.QuerySet(this,this.queriesToQuerySetsAndCallbacks)}disconnect(){var e;null===(e=this.ws)||void 0===e||e.close()}getConfig(){return this.config}getId(){return this.id}isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}convertInitialData(e){for(let t in e){let s=t.split(".");if(s.length<=1)continue;let r=e;for(let e=0;e<s.length;e++)void 0===r[s[e]]&&(r[s[e]]={}),e<s.length-1&&(r=r[s[e]]);r[s[s.length-1]]=e[t],delete e[t]}return e}handleGlobalListener(e){var t;try{null===(t=this.globalListener)||void 0===t||t.call(this,e)}catch(e){console.warn("Error while handling global error listener",e)}}handleErrorListenerForMap(e,t,s){for(const[r,i]of e.qsErrCb)for(let e of i)try{e(s)}catch(e){console.warn(`Error while handling error listener for query: ${t}`,e)}}updatePingInterval(){var e;void 0!==this.pingIntervalId&&clearInterval(this.pingIntervalId);let t=this;this.pingIntervalId=setInterval((()=>{var e;null===(e=t.ws)||void 0===e||e.send("{1}")}),null!==(e=t.config.pingSeconds)&&void 0!==e?e:29e3)}}},977:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryBatch=void 0,t.QueryBatch=class{constructor(e,t,s,r,i,n,o,l,a){this.subscribeQueries=[],this.retrieveAndSubscribeQueries=[],this.retrieveQueries=[],this.unsubscribeQueries=[],this.retrieveList=e,this.retrieveAndSubscribeList=t,this.subscribeList=s,this.unsubscribeList=r,this.addCallbackToQueries=i,this.removeCallbacksForQuery=n,this.queriesToQuerySetsAndCallbacks=o,this.querySet=l,this.connection=a}subscribe(e,t,s){return this.subscribeQueries.push({query:e,listener:t,errorListener:s}),this}retrieveAndSubscribe(e,t,s){return this.retrieveAndSubscribeQueries.push({query:e,listener:t,errorListener:s}),this}retrieve(e,t,s){return this.retrieveQueries.push({query:e,listener:t,errorListener:s}),this}unsubscribe(e){return this.unsubscribeQueries.push(e),this}assemble(){this.retrieveList(this.retrieveQueries,this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this.querySet,this.connection),this.retrieveAndSubscribeList(this.retrieveAndSubscribeQueries,this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this.querySet,this.connection),this.subscribeList(this.subscribeQueries,this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this.querySet,this.connection),this.unsubscribeList(this.unsubscribeQueries,this.removeCallbacksForQuery,this.queriesToQuerySetsAndCallbacks,this.querySet,this.connection)}}},721:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QuerySet=void 0;const r=s(977);t.QuerySet=class{constructor(e,t){this.connection=e,this.queriesToQuerySetsAndCallbacks=t}subscribe(e,t,s){this.subscribeList([{query:e,listener:t,errorListener:s}],this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this,this.connection)}subscribeList(e,t,s,r,i){let n=[];for(const i of e){let e=t([i.query],i.listener,i.errorListener,!1,!1,s,r);n.push(...e)}if(n.length){const e=JSON.stringify({action:"add",queries:n});i.send(e)}}retrieveAndSubscribe(e,t,s){this.retrieveAndSubscribeList([{query:e,listener:t,errorListener:s}],this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this,this.connection)}retrieveAndSubscribeList(e,t,s,r,i){let n=[];for(const i of e){let e=t([i.query],i.listener,i.errorListener,!1,!0,s,r);n.push(...e)}if(n.length){const e=JSON.stringify({action:"add",initialData:"TRUE",queries:n});i.send(e)}}retrieve(e,t,s){this.retrieveList([{query:e,listener:t,errorListener:s}],this.addCallbackToQueries,this.queriesToQuerySetsAndCallbacks,this,this.connection)}retrieveList(e,t,s,r,i){let n=[];for(const i of e){let e=t([i.query],i.listener,i.errorListener,!0,!0,s,r);n.push(...e)}if(n.length){const e=JSON.stringify({action:"add",once:"TRUE",initialData:"TRUE",queries:n});i.send(e)}}unsubscribe(e){this.unsubscribeList([e],this.removeCallbacksForQuery,this.queriesToQuerySetsAndCallbacks,this,this.connection)}unsubscribeList(e,t,s,r,i){let n=t(e,s,r);if(n.length){const e=JSON.stringify({action:"remove",queries:n});i.send(e)}}unsubscribeAll(){let e=Array.from(this.queriesToQuerySetsAndCallbacks.keys());this.unsubscribeList(e,this.removeCallbacksForQuery,this.queriesToQuerySetsAndCallbacks,this,this.connection)}batch(){return new r.QueryBatch(this.retrieveList,this.retrieveAndSubscribeList,this.subscribeList,this.unsubscribeList,this.addCallbackToQueries,this.removeCallbacksForQuery,this.queriesToQuerySetsAndCallbacks,this,this.connection)}addCallbackToQueries(e,t,s,r,i,n,o){let l=[];for(let a of e){let e=n.get(a);if(e){if(e.once!==r)return l}else e={qsCb:new Map,qsErrCb:new Map,once:!1,initial:!1,count:0};(0===e.qsCb.size||e.once!==r)&&(e.once=r,e.count=0,e.initial=i,l.push(a));let c=e.qsCb.get(o);if(null!=c||(c=[]),c.push(t),e.qsCb.set(o,c),s){let t=e.qsErrCb.get(o);null!=t||(t=[]),t.push(s),e.qsErrCb.set(o,t)}n.set(a,e)}return l}removeCallbacksForQuery(e,t,s){let r=[];for(let i of e){let e=t.get(i);e&&(e.qsCb.delete(s),e.qsErrCb.delete(s),0===e.qsCb.size&&(t.delete(i),r.push(i)))}return r}}}},t={};function s(r){var i=t[r];if(void 0!==i)return i.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,s),n.exports}var r={};return(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.connect=void 0;const t=s(670);e.connect=function(e,s){let r=new t.Connection(e,s);return r.connect(),r}})(),r})()));