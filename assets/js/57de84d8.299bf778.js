"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[29890],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=c(n),d=o,k=m["".concat(l,".").concat(d)]||m[d]||p[d]||a;return n?r.createElement(k,s(s({ref:t},u),{},{components:n})):r.createElement(k,s({ref:t},u))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},14008:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var r=n(87462),o=(n(67294),n(3905));const a={sidebar_position:10,title:"REMOVE"},s=void 0,i={unversionedId:"queryworkers/c8ql/operations/remove",id:"queryworkers/c8ql/operations/remove",title:"REMOVE",description:"The REMOVE keyword can be used to remove documents from a collection. On a single server, the document removal is executed transactionally in an all-or-nothing fashion.",source:"@site/docs/queryworkers/c8ql/operations/remove.md",sourceDirName:"queryworkers/c8ql/operations",slug:"/queryworkers/c8ql/operations/remove",permalink:"/docs/queryworkers/c8ql/operations/remove",draft:!1,editUrl:"https://github.com/macrometacorp/docs/edit/main/docs/queryworkers/c8ql/operations/remove.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10,title:"REMOVE"},sidebar:"defaultSidebar",previous:{title:"COLLECT",permalink:"/docs/queryworkers/c8ql/operations/collect"},next:{title:"UPDATE",permalink:"/docs/queryworkers/c8ql/operations/update"}},l={},c=[{value:"Setting query options",id:"setting-query-options",level:2},{value:"Returning the removed documents",id:"returning-the-removed-documents",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"REMOVE")," keyword can be used to remove documents from a collection. On a single server, the document removal is executed transactionally in an all-or-nothing fashion. "),(0,o.kt)("p",null,"For sharded collections, the entire query and/or remove operation may not be transactional, especially if it involves different shards and/or DB-Servers."),(0,o.kt)("p",null,"Each ",(0,o.kt)("inlineCode",{parentName:"p"},"REMOVE")," operation is restricted to a single collection, and the ",(0,o.kt)("a",{parentName:"p",href:"/docs/queryworkers/c8ql/operations/remove"},"collection name")," must not be dynamic. Only a single ",(0,o.kt)("inlineCode",{parentName:"p"},"REMOVE")," statement per collection is allowed per C8QL query, and it cannot be followed by read or write operations that access the same collection, by traversal operations, or C8QL functions that can read documents."),(0,o.kt)("p",null,"The syntax for a remove operation is:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"REMOVE keyExpression IN collection options\n")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"collection")," must contain the name of the collection to remove the documents from. ",(0,o.kt)("em",{parentName:"p"},"keyExpression")," must be an expression that contains the document identification. This can either be a string (which must then contain the ",(0,o.kt)("a",{parentName:"p",href:"/docs/queryworkers/c8ql/operations/remove"},"document key"),") or a document, which must contain a ",(0,o.kt)("em",{parentName:"p"},"_key")," attribute."),(0,o.kt)("p",null,"The following queries are thus equivalent:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR u IN users\n  REMOVE { _key: u._key } IN users\n\nFOR u IN users\n  REMOVE u._key IN users\n\nFOR u IN users\n  REMOVE u IN users\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": A remove operation can remove arbitrary documents, and the documents do not need to be identical to the ones produced by a preceding ",(0,o.kt)("inlineCode",{parentName:"p"},"FOR")," statement:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR i IN 1..1000\n  REMOVE { _key: CONCAT('test', i) } IN users\n\nFOR u IN users\n  FILTER u.active == false\n  REMOVE { _key: u._key } IN backup\n")),(0,o.kt)("p",null,"A single document can be removed as well, using a document key string or a\ndocument with ",(0,o.kt)("inlineCode",{parentName:"p"},"_key")," attribute:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"REMOVE 'john' IN users\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"LET doc = DOCUMENT('users/john')\nREMOVE doc IN users\n")),(0,o.kt)("p",null,"The restriction of a single remove operation per query and collection applies. The following query causes an ",(0,o.kt)("em",{parentName:"p"},"access after data-modification")," error because of the third remove operation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"REMOVE 'john' IN users\nREMOVE 'john' IN backups // OK, different collection\nREMOVE 'mary' IN users   // Error, users collection again\n")),(0,o.kt)("h2",{id:"setting-query-options"},"Setting query options"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"options")," can be used to suppress query errors that may occur when trying to remove non-existing documents. For example, the following query will fail if one of the to-be-deleted documents does not exist:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR i IN 1..1000\n  REMOVE { _key: CONCAT('test', i) } IN users\n")),(0,o.kt)("p",null,"By specifying the ",(0,o.kt)("em",{parentName:"p"},"ignoreErrors")," query option, these errors can be suppressed so\nthe query completes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR i IN 1..1000\n  REMOVE { _key: CONCAT('test', i) } IN users OPTIONS { ignoreErrors: true }\n")),(0,o.kt)("p",null,"To make sure data has been written to disk when a query returns, there is the ",(0,o.kt)("em",{parentName:"p"},"waitForSync"),"\nquery option:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR i IN 1..1000\n  REMOVE { _key: CONCAT('test', i) } IN users OPTIONS { waitForSync: true }\n")),(0,o.kt)("p",null,"In order to not accidentially remove documents that have been updated since you last fetched them, you can use the option ",(0,o.kt)("em",{parentName:"p"},"ignoreRevs")," to either let GDN compare the ",(0,o.kt)("inlineCode",{parentName:"p"},"_rev")," values and only succeed if they still match, or let GDN ignore them (default):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR i IN 1..1000\n  REMOVE { _key: CONCAT('test', i), _rev: \"1287623\" } IN users OPTIONS { ignoreRevs: false }\n")),(0,o.kt)("p",null,"The DB engine does not require collection-level locks. Different write operations on the same collection do not block each other, as long as there are no ",(0,o.kt)("em",{parentName:"p"},"write-write conficts")," on the same documents. From an application development perspective it can be desired to have exclusive write access on collections, to simplify the development. Note that writes do not block reads in DB."),(0,o.kt)("p",null,"Exclusive access can also speed up modification queries, because we avoid conflict checks."),(0,o.kt)("p",null,"Use the ",(0,o.kt)("em",{parentName:"p"},"exclusive")," option to achieve this  effect on a per query basis:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"    FOR doc IN collection\n      REPLACE doc._key \n      WITH { replaced: true } \n      OPTIONS { exclusive: true }\n")),(0,o.kt)("h2",{id:"returning-the-removed-documents"},"Returning the removed documents"),(0,o.kt)("p",null,"The removed documents can also be returned by the query. In this case, the ",(0,o.kt)("inlineCode",{parentName:"p"},"REMOVE")," statement must be followed by a ",(0,o.kt)("inlineCode",{parentName:"p"},"RETURN")," statement (intermediate ",(0,o.kt)("inlineCode",{parentName:"p"},"LET")," statements are allowed, too).",(0,o.kt)("inlineCode",{parentName:"p"},"REMOVE")," introduces the pseudo-value ",(0,o.kt)("inlineCode",{parentName:"p"},"OLD")," to refer to the removed documents:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"REMOVE keyExpression IN collection options RETURN OLD\n")),(0,o.kt)("p",null,"Following is an example using a variable named ",(0,o.kt)("inlineCode",{parentName:"p"},"removed")," for capturing the removed documents. For each removed document, the document key will be returned."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR u IN users\n  REMOVE u IN users \n  LET removed = OLD \n  RETURN removed._key\n")))}p.isMDXComponent=!0}}]);