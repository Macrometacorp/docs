"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[87570],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>d});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=c(a),d=r,h=u["".concat(s,".").concat(d)]||u[d]||p[d]||o;return a?n.createElement(h,i(i({ref:t},m),{},{components:a})):n.createElement(h,i({ref:t},m))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},8362:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const o={sidebar_position:10,title:"Enrich Data with a Collection"},i=void 0,l={unversionedId:"cep/enrich-data/enrich-data-with-collection",id:"cep/enrich-data/enrich-data-with-collection",title:"Enrich Data with a Collection",description:"This page explains how to enrich the data in a specific stream by joining it with a Macrometa collection.",source:"@site/docs/cep/enrich-data/enrich-data-with-collection.md",sourceDirName:"cep/enrich-data",slug:"/cep/enrich-data/enrich-data-with-collection",permalink:"/docs/cep/enrich-data/enrich-data-with-collection",draft:!1,editUrl:"https://github.com/macrometacorp/docs/edit/main/docs/cep/enrich-data/enrich-data-with-collection.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10,title:"Enrich Data with a Collection"},sidebar:"defaultSidebar",previous:{title:"Join and Enrich Data",permalink:"/docs/cep/enrich-data/"},next:{title:"Enrich Data with Another Stream",permalink:"/docs/cep/enrich-data/enrich-data-with-stream"}},s={},c=[{value:"Create a Stream Worker",id:"create-a-stream-worker",level:2},{value:"Stream Worker Explanation",id:"stream-worker-explanation",level:2},{value:"Metadata",id:"metadata",level:3},{value:"Input and Output",id:"input-and-output",level:3},{value:"Define the Source Stream",id:"define-the-source-stream",level:4},{value:"Define the Table (Collection)",id:"define-the-table-collection",level:4},{value:"Define the Sink Stream",id:"define-the-sink-stream",level:4},{value:"Data Enrichment Query",id:"data-enrichment-query",level:3},{value:"Insert Data",id:"insert-data",level:4},{value:"Select Data",id:"select-data",level:4},{value:"Join Data",id:"join-data",level:4},{value:"Test the Stream Worker",id:"test-the-stream-worker",level:2},{value:"1. Load UserTable Collection with User Data",id:"1-load-usertable-collection-with-user-data",level:3},{value:"2. Open a Stream Window",id:"2-open-a-stream-window",level:3},{value:"3. Publish Events and Observe Output",id:"3-publish-events-and-observe-output",level:3}],m={toc:c};function p(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This page explains how to enrich the data in a specific stream by joining it with a Macrometa ",(0,r.kt)("a",{parentName:"p",href:"/docs/collections/"},"collection"),"."),(0,r.kt)("p",null,"For this purpose, consider a scenario where you receive sales records generated from multiple locations as events from an external system."),(0,r.kt)("h2",{id:"create-a-stream-worker"},"Create a Stream Worker"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://auth-play.macrometa.io/"},"Log in to your Macrometa account"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Stream Worker"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the Editor tab, you must define the stream worker. Copy and paste the following code block in the code editor on the Editor tab. An explanation is below if you want more information than is available in the code comments."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'@App:name("EnrichingTransactionsApp")\n@App:qlVersion("2")\n@App:description(\'An application for enriching transactions.\')\n/**\nTest the stream worker:\n1. If they are not already present, then run the following query to add the records to the UserTable collection.\n\n    LET data = [\n    {"userId":1200001,"firstName":"Raleigh","lastName":"McGilvra"},\n    {"userId":1200002,"firstName":"Marty","lastName":"Mueller"},\n    {"userId":1200003,"firstName":"Kelby","lastName":"Mattholie"}\n    ]\n\n    FOR d IN data\n        INSERT d INTO UserTable\n\n2. Open a stream window to view c8locals.EnrichedTransactionStream output.\n\n3. Send the following message to c8locals.TransactionStream:\n\n    "userId":1200002,"transactionAmount":803,"location":"Chicago",\n\n    c8locals.EnrichedTransactionStream output should be:\n\n    {"transactionAmount":803.0,"location":"Chicago","userName":"Marty Mueller","userId":1200002,}\n\n4. Send the following message to c8locals.TransactionStream:\n\n    "userId":1200001,"transactionAmount":1023,"location":"New York"\n\n    c8locals.EnrichedTransactionStream output should be:\n\n    {"transactionAmount":1023.0,"location":"New York","userName":"Raleigh McGilvra","userId":1200001}\n\n**/\n\n-- Define the stream.\nCREATE STREAM TransactionStream (userId long, transactionAmount double, location string);\n\n-- Define the table (collection).\nCREATE TABLE GLOBAL UserTable (userId long, firstName string, lastName string);\n\nCREATE SINK EnrichedTransactionStream WITH (type=\'stream\', stream=\'EnrichedTransactionStream\', map.type=\'json\') (userId long, userName string, transactionAmount double, location string);\n\ninsert into EnrichedTransactionStream\nfrom UserTable as u join TransactionStream as t on u.userId == t.userId;\nselect u.userId, str:concat( u.firstName, " ", u.lastName) as userName, transactionAmount, location\n\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Validate"),". Macrometa checks to see that your code is valid.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Save"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Select edge locations, and then click ",(0,r.kt)("strong",{parentName:"p"},"Save"),". The locations that you select represent where the data for this stream worker will live.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Publish")," to publish your stream worker. When you do this, it will begin to run the code as defined and will continue until you unpublish it."))),(0,r.kt)("h2",{id:"stream-worker-explanation"},"Stream Worker Explanation"),(0,r.kt)("p",null,"This section explains the parts of this stream worker and what they are doing."),(0,r.kt)("h3",{id:"metadata"},"Metadata"),(0,r.kt)("p",null,"This information defines basic information about the stream worker. Every stream worker must have at least a name and query language version in order to be valid."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name")," - ",(0,r.kt)("inlineCode",{parentName:"li"},'@App:name("EnrichingTransactionsApp")')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Query language version"),' - @App:qlVersion("2")'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Description (optional)")," - @App:description('An application for enriching transactions.')"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Other information (optional)")," - By convention, you can enter a comment with testing information, update logs, or other useful information at the beginning of the stream worker definition between ",(0,r.kt)("inlineCode",{parentName:"li"},"/**")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"**/"),". This is similar to a docstring in functions.")),(0,r.kt)("h3",{id:"input-and-output"},"Input and Output"),(0,r.kt)("p",null,"Define the input stream and the Macrometa collection that need to be joined as follows. If the stream or collection do not exist, then Macrometa creates them when you publish the stream worker."),(0,r.kt)("h4",{id:"define-the-source-stream"},"Define the Source Stream"),(0,r.kt)("p",null,"This stream is where the data is coming from. For more information about defining a STREAM in a stream worker, refer to ",(0,r.kt)("a",{parentName:"p",href:"/docs/cep/query-guide/stream"},"STREAM")," in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/cep/query-guide/"},"Query Guide"),". For more information about streams in general, refer to ",(0,r.kt)("a",{parentName:"p",href:"/docs/streams/"},"Streams"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE STREAM TransactionStream (userId long, transactionAmount double, location string);\n")),(0,r.kt)("h4",{id:"define-the-table-collection"},"Define the Table (Collection)"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"CREATE TABLE")," defines where the stream worker stores your data. In this case, it will be a ",(0,r.kt)("a",{parentName:"p",href:"/docs/collections/documents/"},"Document Store Collection")," For more information about defining a TABLE in a stream worker, refer to ",(0,r.kt)("a",{parentName:"p",href:"/docs/cep/query-guide/table-collection"},"Table (Collection)"),". For more information about collections in general, refer to ",(0,r.kt)("a",{parentName:"p",href:"/docs/collections/"},"Collections"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE GLOBAL UserTable (userId long, firstName string, lastName string);\n")),(0,r.kt)("h4",{id:"define-the-sink-stream"},"Define the Sink Stream"),(0,r.kt)("p",null,"The sink stream is where the stream worker sends your data."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE SINK EnrichedTransactionStream WITH (type='stream', stream='EnrichedTransactionStream', map.type='json') (userId long, userName string, transactionAmount double, location string);\n")),(0,r.kt)("h3",{id:"data-enrichment-query"},"Data Enrichment Query"),(0,r.kt)("p",null,"Define the query for a stream to join the stream and the table, and then handle the result. This section examines the query line by line."),(0,r.kt)("h4",{id:"insert-data"},"Insert Data"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"insert into")," clause defines an output stream into which the enriched data is directed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"insert into EnrichedTransactionStream;\n")),(0,r.kt)("h4",{id:"select-data"},"Select Data"),(0,r.kt)("p",null,"A ",(0,r.kt)("inlineCode",{parentName:"p"},"select")," clause specifies how the value for each attribute in the output stream is derived. The variables used for the attributes are defined in the next line where you ",(0,r.kt)("a",{parentName:"p",href:"#join-data"},"join data"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'select u.userId, str:concat( u.firstName, " ", u.lastName) as userName, transactionAmount, location\n')),(0,r.kt)("p",null,"Note the following in the ",(0,r.kt)("inlineCode",{parentName:"p"},"select")," statement:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"userId")," attribute name is common to both the stream and the table. Therefore, you need to specify from where this attribute needs to be taken. Here, you can also specify ",(0,r.kt)("inlineCode",{parentName:"li"},"t.userId")," instead of ",(0,r.kt)("inlineCode",{parentName:"li"},"u.userId"),"."),(0,r.kt)("li",{parentName:"ul"},"You are specifying the output generated to include an attribute named ",(0,r.kt)("inlineCode",{parentName:"li"},"userName"),". The value for that is derived\nby concatenating the values of the ",(0,r.kt)("inlineCode",{parentName:"li"},"firstName")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"lastName")," attributes in the ",(0,r.kt)("inlineCode",{parentName:"li"},"UserTable")," table using the ",(0,r.kt)("inlineCode",{parentName:"li"},"str:concat()")," function."),(0,r.kt)("li",{parentName:"ul"},"You can apply any of the range of streams functions available to further enrich the joined output.")),(0,r.kt)("h4",{id:"join-data"},"Join Data"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"from")," clause together with the ",(0,r.kt)("inlineCode",{parentName:"p"},"join")," keyword join the table and the stream."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"from UserTable as u join TransactionStream as t on u.userId == t.userId\n")),(0,r.kt)("p",null,"Note the following about the ",(0,r.kt)("inlineCode",{parentName:"p"},"from")," clause:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The input data is taken from both a stream and a table. You need to assign a unique reference for each of them to allow the query to differentiate between the common attributes. In this example, ",(0,r.kt)("inlineCode",{parentName:"li"},"TransactionStream")," stream is referred to as ",(0,r.kt)("inlineCode",{parentName:"li"},"t"),", and the ",(0,r.kt)("inlineCode",{parentName:"li"},"UserTable")," table is referred to as ",(0,r.kt)("inlineCode",{parentName:"li"},"u"),"."),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"join")," keyword joins the stream and the table together and defines the unique references."),(0,r.kt)("li",{parentName:"ul"},"The condition for the stream and the table to be joined is ",(0,r.kt)("inlineCode",{parentName:"li"},"t.userId == u.userId"),", which means that for an event to be taken from the ",(0,r.kt)("inlineCode",{parentName:"li"},"TransactionStream")," for the join, one or more events that have the same value for the ",(0,r.kt)("inlineCode",{parentName:"li"},"userId")," must exist in the ",(0,r.kt)("inlineCode",{parentName:"li"},"UserTable")," table and vice versa.")),(0,r.kt)("h2",{id:"test-the-stream-worker"},"Test the Stream Worker"),(0,r.kt)("p",null,"To check whether the above stream worker works as expected follow below steps"),(0,r.kt)("h3",{id:"1-load-usertable-collection-with-user-data"},"1. Load UserTable Collection with User Data"),(0,r.kt)("p",null,"Run the following query using one of the methods described in ",(0,r.kt)("a",{parentName:"p",href:"/docs/queryworkers/running-queries"},"Running Queries")," to add the records to the collection. Each line is a separate record."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'LET data = [\n   {"userId":1200001,"firstName":"Raleigh","lastName":"McGilvra"},\n   {"userId":1200002,"firstName":"Marty","lastName":"Mueller"},\n   {"userId":1200003,"firstName":"Kelby","lastName":"Mattholie"}\n   ]\n\nFOR d IN data\n    INSERT d INTO UserTable\n')),(0,r.kt)("h3",{id:"2-open-a-stream-window"},"2. Open a Stream Window"),(0,r.kt)("p",null,"The Macrometa Streams console does not persist messages, so in order to see them, you must have the console open before you send."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In a new tab or window, open the Macrometa console."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Streams"),"."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"c8locals.EnrichedTransactionStream"),".")),(0,r.kt)("h3",{id:"3-publish-events-and-observe-output"},"3. Publish Events and Observe Output"),(0,r.kt)("p",null,"There are several ways to ",(0,r.kt)("a",{parentName:"p",href:"/docs/streams/stream-tasks/publish-messages"},"publish messages to streams"),", this page shows you how to do it in the Macrometa console API reference."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the original tab or window (not the one with the stream open), click ",(0,r.kt)("strong",{parentName:"p"},"API Reference"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the API Reference pane, click to expand ",(0,r.kt)("strong",{parentName:"p"},"Streams")," and then click the POST command ",(0,r.kt)("strong",{parentName:"p"},"Publish message"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Try it out"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("strong",{parentName:"p"},"fabric"),", enter the fabric your stream worker is associated with. This is the fabric you were logged in to when you created the stream worker, probably ",(0,r.kt)("inlineCode",{parentName:"p"},"_system"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("strong",{parentName:"p"},"stream"),", enter ",(0,r.kt)("inlineCode",{parentName:"p"},"c8locals.TransactionStream"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Copy and paste the following transaction code block into ",(0,r.kt)("strong",{parentName:"p"},"Message"),", between the curly brackets:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"userId":1200002,"transactionAmount":803,"location":"Chicago",\n')),(0,r.kt)("p",{parentName:"li"},"The stream worker enriches the transaction information and sends the following message to ",(0,r.kt)("inlineCode",{parentName:"p"},"EnrichedTransactionStream"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"transactionAmount":803.0,"location":"Chicago","userName":"Marty Mueller","userId":1200002,}\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"To test a second time, copy and paste the following transaction code block into ",(0,r.kt)("strong",{parentName:"p"},"Message"),", between the curly brackets::"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"userId":1200001,"transactionAmount":1023,"location":"New York"\n')),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"transactionAmount":1023.0,"location":"New York","userName":"Raleigh McGilvra","userId":1200001}\n')))))}p.isMDXComponent=!0}}]);