"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[17],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),c=d(n),m=i,h=c["".concat(s,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(h,l(l({ref:t},p),{},{components:n})):a.createElement(h,l({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,l=new Array(o);l[0]=c;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:i,l[1]=r;for(var d=2;d<o;d++)l[d]=n[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},48781:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return r},metadata:function(){return d},toc:function(){return u}});var a=n(87462),i=n(63366),o=(n(67294),n(3905)),l=["components"],r={sidebar_position:3,title:"Working with Indexes"},s="Working with Indexes",d={unversionedId:"collections/documents/indexing/working-with-indexes",id:"collections/documents/indexing/working-with-indexes",title:"Working with Indexes",description:"Indexing Attributes & Sub-Attributes",source:"@site/docs/collections/documents/indexing/working-with-indexes.md",sourceDirName:"collections/documents/indexing",slug:"/collections/documents/indexing/working-with-indexes",permalink:"/docs/collections/documents/indexing/working-with-indexes",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"Working with Indexes"},sidebar:"tutorialSidebar",previous:{title:"Index Utilization",permalink:"/docs/collections/documents/indexing/index-utilization"},next:{title:"Which Index to use when",permalink:"/docs/collections/documents/indexing/which-index"}},p={},u=[{value:"Indexing Attributes &amp; Sub-Attributes",id:"indexing-attributes--sub-attributes",level:2},{value:"Indexing Array Values",id:"indexing-array-values",level:2},{value:"Persistent Indexes",id:"persistent-indexes",level:2},{value:"Introduction",id:"introduction",level:3},{value:"Accessing Persistent Indexes",id:"accessing-persistent-indexes",level:3},{value:"Query by example",id:"query-by-example",level:3},{value:"TTL (time-to-live) Indexes",id:"ttl-time-to-live-indexes",level:2},{value:"Introduction",id:"introduction-1",level:3},{value:"Removing documents at a fixed period after creation / update",id:"removing-documents-at-a-fixed-period-after-creation--update",level:3},{value:"Removing documents at certain points in time",id:"removing-documents-at-certain-points-in-time",level:3},{value:"Format of date/time values",id:"format-of-datetime-values",level:3},{value:"Preventing documents from being removed",id:"preventing-documents-from-being-removed",level:3},{value:"Limitations",id:"limitations",level:3},{value:"Accessing TTL Indexes",id:"accessing-ttl-indexes",level:3},{value:"Fulltext Indexes",id:"fulltext-indexes",level:2},{value:"Introduction",id:"introduction-2",level:3},{value:"Accessing Fulltext Indexes",id:"accessing-fulltext-indexes",level:3},{value:"Fulltext C8QL Functions",id:"fulltext-c8ql-functions",level:3},{value:"Geo-Spatial Indexes",id:"geo-spatial-indexes",level:2},{value:"GeoJSON Mode",id:"geojson-mode",level:3},{value:"Non-GeoJSON mode",id:"non-geojson-mode",level:3},{value:"Indexed GeoSpatial Queries",id:"indexed-geospatial-queries",level:3},{value:"Query for Results near Origin (NEAR type query)",id:"query-for-results-near-origin-near-type-query",level:4},{value:"Query for Sorted Results near Origin (NEAR type query)",id:"query-for-sorted-results-near-origin-near-type-query",level:4},{value:"Query for Results within Distance",id:"query-for-results-within-distance",level:4},{value:"Query for Results contained in Polygon",id:"query-for-results-contained-in-polygon",level:4},{value:"Query for Results Intersecting a Polygon",id:"query-for-results-intersecting-a-polygon",level:4},{value:"GeoJSON",id:"geojson",level:3},{value:"Point",id:"point",level:4},{value:"MultiPoint",id:"multipoint",level:4},{value:"LineString",id:"linestring",level:4},{value:"MultiLineString",id:"multilinestring",level:4},{value:"Polygon",id:"polygon",level:4},{value:"MultiPolygon",id:"multipolygon",level:4},{value:"Examples",id:"examples",level:4},{value:"Vertex centric indexes",id:"vertex-centric-indexes",level:2},{value:"Index Identifiers &amp; Handles",id:"index-identifiers--handles",level:2},{value:"Collection Methods",id:"collection-methods",level:2},{value:"GeoFabric Methods",id:"geofabric-methods",level:2},{value:"Creating Indexes in Background",id:"creating-indexes-in-background",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}],c={toc:u};function m(e){var t=e.components,n=(0,i.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"working-with-indexes"},"Working with Indexes"),(0,o.kt)("h2",{id:"indexing-attributes--sub-attributes"},"Indexing Attributes & Sub-Attributes"),(0,o.kt)("p",null,"Top-level as well as nested attributes can be indexed. For attributes at the top level, the attribute names alone are required. To index a single field, pass an array with a single element (string of the attribute key) to the ",(0,o.kt)("em",{parentName:"p"},"fields")," parameter of the ensureIndex() method. "),(0,o.kt)("p",null,"To create an index:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cURL"},'curl -X POST "https://api-gdn.eng.macrometa.io/_fabric/_system/_api/index/hash?collection=c1" \n-H "Authorization: bearer <token>" \n-d "{ \\"fields\\": [ \\"name\\" ], \\"sparse\\": true, \\"type\\": \\"hash\\", \\"unique\\": true}"\n')),(0,o.kt)("p",null,"To create a combined index over multiple fields, add more members to the ",(0,o.kt)("em",{parentName:"p"},"fields")," array. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cURL"},'curl -X POST "https://api-gdn.eng.macrometa.io/_fabric/_system/_api/index/hash?collection=c1"\n-H "Authorization: bearer <token>" \n-d "{ \\"fields\\": [ \\"name\\", \\"age\\" ], \\"sparse\\": true, \\"type\\": \\"hash\\", \\"unique\\": true}"\n')),(0,o.kt)("p",null,"To index sub-attributes, specify the attribute path using the dot notation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cURL"},'curl -X POST "https://api-gdn.eng.macrometa.io/_fabric/_system/_api/index/hash?collection=c1" \n-H "Authorization: bearer <token>" \n-d "{ \\"fields\\": [ \\"name.first\\", \\"name.last\\" ], \\"type\\": \\"hash\\"}"\n')),(0,o.kt)("h2",{id:"indexing-array-values"},"Indexing Array Values"),(0,o.kt)("p",null,"If an index attribute contains an array, GDN will store the entire array as the index value by default. Accessing individual members of the array via the index is not possible this way. "),(0,o.kt)("p",null,"To make an index insert the individual array members into the index instead of the entire array value, a special array index needs to be created for the attribute. Array indexes can be set up like regular hash or skiplist indexes using the ",(0,o.kt)("inlineCode",{parentName:"p"},"collection.ensureIndex()")," function. To make a hash or skiplist index an array index, the index attribute name needs to be extended with ",(0,o.kt)("i",null,"[*]")," when creating the index and when filtering in a C8QL query using the ",(0,o.kt)("inlineCode",{parentName:"p"},"IN")," operator."),(0,o.kt)("p",null,"The following example creates an array hash index on the ",(0,o.kt)("inlineCode",{parentName:"p"},"tags")," attribute in a collection named ",(0,o.kt)("inlineCode",{parentName:"p"},"posts"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cURL"},'curl -X POST "https://api-gdn.eng.macrometa.io/_fabric/_system/_api/document/c1" \n-H "Authorization: bearer <token>"\n-d "{ \\"tags\\" : [ \\"foobar\\", \\"baz\\", \\"quux\\" ]}"\n')),(0,o.kt)("p",null,"This array index can then be used for looking up individual ",(0,o.kt)("inlineCode",{parentName:"p"},"tags")," values from C8QL queries via the ",(0,o.kt)("inlineCode",{parentName:"p"},"IN")," operator:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR doc IN posts\n  FILTER 'foobar' IN doc.tags\n  RETURN doc\n")),(0,o.kt)("p",null,"It is possible to add the ",(0,o.kt)("a",{parentName:"p",href:"/docs/c8ql/array-operators#array-expansion"},"array expansion operator")," ",(0,o.kt)("i",null,"[*]"),", but it is not mandatory. You may use it to indicate that an array index is used, it is purely cosmetic however:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR doc IN posts\n  FILTER 'foobar' IN doc.tags[*]\n  RETURN doc\n")),(0,o.kt)("p",null,"The following FILTER conditions will ",(0,o.kt)("em",{parentName:"p"},"not")," use the array index:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FILTER doc.tags ANY == 'foobar'\nFILTER doc.tags ANY IN 'foobar'\nFILTER doc.tags IN 'foobar'\nFILTER doc.tags == 'foobar'\nFILTER 'foobar' == doc.tags\n")),(0,o.kt)("p",null,"It is also possible to create an index on subattributes of array values. This makes sense if the index attribute is an array of objects, e.g."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cURL"},'curl -X POST "https://api-gdn.eng.macrometa.io/_fabric/_system/_api/document/c1" \n-H "Authorization: bearer <token>"\n-d "{ \\"tags\\": [ { \\"name\\": \\"foobar\\" }, { \\"name\\": \\"baz\\" }, { \\"name\\": \\"quux\\" } ] }"\n')),(0,o.kt)("p",null,"The following query will then use the array index (this does require the ",(0,o.kt)("a",{parentName:"p",href:"/docs/collections/documents/indexing/working-with-indexes"},"array expansion operator"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"FOR doc IN posts\n  FILTER 'foobar' IN doc.tags[*].name\n  RETURN doc\n")),(0,o.kt)("p",null,"If you store a document having the array which does contain elements not having the subattributes this document will also be indexed with the value ",(0,o.kt)("inlineCode",{parentName:"p"},"null"),", which in GDN is equal to attribute not existing."),(0,o.kt)("p",null,"GDN supports creating array indexes with a single ",(0,o.kt)("i",null,"[*]")," operator per index attribute. For example, creating an index as follows is ",(0,o.kt)("em",{parentName:"p"},"not")," supported:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.ensureIndex({ type: "hash", fields: [ "tags[*].name[*].value" ] });\n')),(0,o.kt)("p",null,"Array values will automatically be de-duplicated before being inserted into an array index. For example, if the following document is inserted into the collection, the duplicate array value ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," will be inserted only once:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.insert({ tags: [ "foobar", "bar", "bar" ] });\n')),(0,o.kt)("p",null,"This is done to avoid redudant storage of the same index value for the same document, which would not provide any benefit."),(0,o.kt)("p",null,"If an array index is declared ",(0,o.kt)("strong",{parentName:"p"},"unique"),", the de-duplication of array values will happen before inserting the values into the index, so the above insert operation with two identical values ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," will not necessarily fail"),(0,o.kt)("p",null,"It will always fail if the index already contains an instance of the ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," value. However, if the value ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," is not already present in the index, then the de-duplication of the array values will effectively lead to ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," being inserted only once."),(0,o.kt)("p",null,"To turn off the deduplication of array values, it is possible to set the ",(0,o.kt)("strong",{parentName:"p"},"deduplicate")," attribute on the array index to ",(0,o.kt)("inlineCode",{parentName:"p"},"false"),". The default value for ",(0,o.kt)("strong",{parentName:"p"},"deduplicate")," is ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," however, so de-duplication will take place if not explicitly turned off."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.ensureIndex({ type: "hash", fields: [ "tags[*]" ], deduplicate: false });\n\n// will fail now\nposts.insert({ tags: [ "foobar", "bar", "bar" ] }); \n')),(0,o.kt)("p",null,"If an array index is declared and you store documents that do not have an array at the specified attribute this document will not be inserted in the index. Hence the following objects will not be indexed:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.ensureIndex({ type: "hash", fields: [ "tags[*]" ] });\nposts.insert({ something: "else" });\nposts.insert({ tags: null });\nposts.insert({ tags: "this is no array" });\nposts.insert({ tags: { content: [1, 2, 3] } });\n')),(0,o.kt)("p",null,"An array index is able to index explicit ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," values. When queried for ",(0,o.kt)("inlineCode",{parentName:"p"},"null"),"values, it will only return those documents having explicitly ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," stored in the array, it will not return any documents that do not have the array at all."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.ensureIndex({ type: "hash", fields: [ "tags[*]" ] });\nposts.insert({tags: null}) // Will not be indexed\nposts.insert({tags: []})  // Will not be indexed\nposts.insert({tags: [null]}); // Will be indexed for null\nposts.insert({tags: [null, 1, 2]}); // Will be indexed for null, 1 and 2\n')),(0,o.kt)("p",null,"Declaring an array index as ",(0,o.kt)("strong",{parentName:"p"},"sparse")," does not have an effect on the array part of the index, this in particular means that explicit ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," values are also indexed in the ",(0,o.kt)("strong",{parentName:"p"},"sparse")," version."),(0,o.kt)("p",null,"If an index is combined from an array and a normal attribute the sparsity will apply for the attribute e.g.:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'posts.ensureIndex({ type: "hash", fields: [ "tags[*]", "name" ], sparse: true });\nposts.insert({tags: null, name: "alice"}) // Will not be indexed\nposts.insert({tags: [], name: "alice"}) // Will not be indexed\nposts.insert({tags: [1, 2, 3]}) // Will not be indexed\nposts.insert({tags: [1, 2, 3], name: null}) // Will not be indexed\nposts.insert({tags: [1, 2, 3], name: "alice"})\n// Will be indexed for [1, "alice"], [2, "alice"], [3, "alice"]\nposts.insert({tags: [null], name: "bob"})\n// Will be indexed for [null, "bob"] \n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Filtering using array indexes only works from within C8QL queries and only if the query filters on the indexed attribute using the ",(0,o.kt)("inlineCode",{parentName:"p"},"IN")," operator. The other comparison operators (",(0,o.kt)("inlineCode",{parentName:"p"},"=="),", ",(0,o.kt)("inlineCode",{parentName:"p"},"!="),", ",(0,o.kt)("inlineCode",{parentName:"p"},">"),", ",(0,o.kt)("inlineCode",{parentName:"p"},">="),", ",(0,o.kt)("inlineCode",{parentName:"p"},"<"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"<="),", ",(0,o.kt)("inlineCode",{parentName:"p"},"ANY"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"ALL"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"NONE"),") currently cannot use array indexes."))),(0,o.kt)("h2",{id:"persistent-indexes"},"Persistent Indexes"),(0,o.kt)("h3",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"This is an introduction to C8DB persistent indexes."),(0,o.kt)("p",null,"It is possible to define a persistent index on one or more attributes (or paths) of documents. The index is then used in queries to locate documents within a given range. If the index is declared unique, then no two documents are allowed to have the same set of attribute values."),(0,o.kt)("p",null,"Creating a new document or updating a document will fail if the uniqueness is violated. If the index is declared sparse, a document will be excluded from the index and no uniqueness checks will be performed if any index attribute value is not set or has a value of ",(0,o.kt)("inlineCode",{parentName:"p"},"null"),". "),(0,o.kt)("h3",{id:"accessing-persistent-indexes"},"Accessing Persistent Indexes"),(0,o.kt)("p",null,"Ensures that a unique persistent index exists\n",(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "persistent", fields: [ "field1", ..., "fieldn" ], unique: true })')),(0,o.kt)("p",null,"Creates a unique persistent index on all documents using ",(0,o.kt)("em",{parentName:"p"},"field1"),", ... ",(0,o.kt)("em",{parentName:"p"},"fieldn")," as attribute paths. At least one attribute path has to be given. The index will be non-sparse by default."),(0,o.kt)("p",null,"All documents in the collection must differ in terms of the indexed attributes. Creating a new document or updating an existing document will will fail if the attribute uniqueness is violated. "),(0,o.kt)("p",null,"To create a sparse unique index, set the ",(0,o.kt)("em",{parentName:"p"},"sparse")," attribute to ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),":"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "persistent", fields: [ "field1", ..., "fieldn" ], unique: true, sparse: true })')),(0,o.kt)("p",null,"In a sparse index all documents will be excluded from the index that do not contain at least one of the specified index attributes or that have a value of ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," in any of the specified index attributes. Such documents will not be indexed, and not be taken into account for uniqueness checks."),(0,o.kt)("p",null,"In a non-sparse index, these documents will be indexed (for non-present indexed attributes, a value of ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," will be used) and will be taken into account for uniqueness checks."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("p",null,"To ensure that a non-unique persistent index exists\n",(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "persistent", fields: [ "field1", ..., "fieldn" ] })')),(0,o.kt)("p",null,"Creates a non-unique persistent index on all documents using ",(0,o.kt)("em",{parentName:"p"},"field1"),", ... ",(0,o.kt)("em",{parentName:"p"},"fieldn")," as attribute paths. At least one attribute path has to be given. The index will be non-sparse by default."),(0,o.kt)("p",null,"To create a sparse unique index, set the ",(0,o.kt)("em",{parentName:"p"},"sparse")," attribute to ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("h3",{id:"query-by-example"},"Query by example"),(0,o.kt)("p",null,"constructs a query-by-example using a persistent index ",(0,o.kt)("inlineCode",{parentName:"p"},"collection.byExample(example)")),(0,o.kt)("p",null,"Selects all documents from the collection that match the specified example and returns a cursor. A persistent index will be used if present."),(0,o.kt)("p",null,"You can use ",(0,o.kt)("em",{parentName:"p"},"toArray"),", ",(0,o.kt)("em",{parentName:"p"},"next"),", or ",(0,o.kt)("em",{parentName:"p"},"hasNext")," to access the result. The result can be limited using the ",(0,o.kt)("em",{parentName:"p"},"skip")," and ",(0,o.kt)("em",{parentName:"p"},"limit")," operator."),(0,o.kt)("p",null,"An attribute name of the form ",(0,o.kt)("em",{parentName:"p"},"a.b")," is interpreted as attribute path, not as attribute. If you use"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a" : { "c" : 1 } }\n')),(0,o.kt)("p",null,"as example, then you will find all documents, such that the attribute ",(0,o.kt)("em",{parentName:"p"},"a")," contains a document of the form ",(0,o.kt)("em",{parentName:"p"},"{c : 1 }"),". For example the document"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a" : { "c" : 1 }, "b" : 1 }\n')),(0,o.kt)("p",null,"will match, but the document"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a" : { "c" : 1, "b" : 1 } }\n')),(0,o.kt)("p",null,"will not."),(0,o.kt)("p",null,"However, if you use"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a.c" : 1 },\n')),(0,o.kt)("p",null,"then you will find all documents, which contain a sub-document in ",(0,o.kt)("em",{parentName:"p"},"a")," that has an attribute ",(0,o.kt)("em",{parentName:"p"},"c")," of value ",(0,o.kt)("em",{parentName:"p"},"1"),". Both the following documents"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a" : { "c" : 1 }, "b" : 1 }\n')),(0,o.kt)("p",null,"and"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{ "a" : { "c" : 1, "b" : 1 } }\n')),(0,o.kt)("p",null,"will match."),(0,o.kt)("h2",{id:"ttl-time-to-live-indexes"},"TTL (time-to-live) Indexes"),(0,o.kt)("h3",{id:"introduction-1"},"Introduction"),(0,o.kt)("p",null,"The TTL index type provided by GDN can be used for removing expired documents from a collection."),(0,o.kt)("p",null,"The TTL index is set up by setting an ",(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," value and by selecting a single document attribute which contains a reference point in time. For each document, that reference point in time can then be specified as a numeric timestamp (Unix timestamp) or a date string in format ",(0,o.kt)("inlineCode",{parentName:"p"},"YYYY-MM-DDTHH:MM:SS")," with an optional timezone offset."),(0,o.kt)("p",null,"All date strings without a timezone offset will be interpreted as UTC dates."),(0,o.kt)("p",null,"Documents will count as expired when wall clock time is beyond the per-document reference point in time value plus the index' ",(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," value added to it. "),(0,o.kt)("h3",{id:"removing-documents-at-a-fixed-period-after-creation--update"},"Removing documents at a fixed period after creation / update"),(0,o.kt)("p",null,"One use case supported by TTL indexes is to remove documents at a fixed duration after they have been created or last updated. This requires setting up the index with an attribute that contains the documents' creation or last-updated time."),(0,o.kt)("p",null,'Let\'s assume the index attribute is set to "creationDate", and the ',(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," attribute of the index was set to 600 seconds (10 minutes)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'    collection.ensureIndex({ type: "ttl", fields: ["creationDate"], expireAfter: 600 });\n')),(0,o.kt)("p",null,"Let's further assume the following document now gets inserted into the collection:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'    { "creationDate" : 1550165973 }\n')),(0,o.kt)("p",null,"This document will be indexed with a reference point in time value of ",(0,o.kt)("inlineCode",{parentName:"p"},"1550165973"),", which translates to the human-readable date/time ",(0,o.kt)("inlineCode",{parentName:"p"},"2019-02-14T17:39:33.000Z"),". The document will expire 600 seconds afterwards, which is at timestamp ",(0,o.kt)("inlineCode",{parentName:"p"},"1550166573")," (or ",(0,o.kt)("inlineCode",{parentName:"p"},"2019-02-14T17:49:33.000Z")," in the human-readable version). From that point on, the document is a candidate for being removed."),(0,o.kt)("p",null,"The numeric date time values for the index attribute need to be specified ",(0,o.kt)("strong",{parentName:"p"},"in seconds")," since January 1st 1970 (Unix timestamp). To calculate the current timestamp using JavaScript in this format, use: ",(0,o.kt)("inlineCode",{parentName:"p"},"Date.now() / 1000"),". To calculate it from an arbitrary ",(0,o.kt)("inlineCode",{parentName:"p"},"Date")," instance, use: ",(0,o.kt)("inlineCode",{parentName:"p"},"Date.getTime() / 1000"),". In C8QL, you also have to divide the timestamp, e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"DATE_NOW() / 1000"),"."),(0,o.kt)("p",null,"Alternatively, the reference points in time can be specified as a date string in format ",(0,o.kt)("inlineCode",{parentName:"p"},"YYYY-MM-DDTHH:MM:SS")," with an optional timezone offset. All date strings without a timezone offset will be interpreted as UTC dates."),(0,o.kt)("p",null,"The above example document using a date string attribute value would be"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'    { "creationDate" : "2019-02-14T17:39:33.000Z" }\n')),(0,o.kt)("p",null,"Now any data-modification access to the document could update the value in the document's ",(0,o.kt)("inlineCode",{parentName:"p"},"creationDate")," attribute to the current date/time, which would prolong the existence of the document and keep it from being expired and removed. "),(0,o.kt)("p",null,"GDN will not automatically set a document's reference point in time on initial insertion or on every subsequent modification of the document. Instead, it is the responsibility of client applications to set and update the reference points in time of documents whenever the use case requires it."),(0,o.kt)("h3",{id:"removing-documents-at-certain-points-in-time"},"Removing documents at certain points in time"),(0,o.kt)("p",null,"Another use case is to specify a per-document expiration/removal point in time, and setting the ",(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," attribute to a low value (e.g. 0 seconds)."),(0,o.kt)("p",null,'Let\'s assume the index attribute is set to "expireDate", and the ',(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," attribute of the index was set to 0 seconds (immediately when wall clock time reaches the value specified in ",(0,o.kt)("inlineCode",{parentName:"p"},"expireDate"),")."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'    collection.ensureIndex({ type: "ttl", fields: ["expireDate"], expireAfter: 0 });\n')),(0,o.kt)("p",null,"When storing the following document in the collection, it will expire at the point in time specified in the document itself:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'    { "expireDate" : "2019-03-28T01:06:00Z" }\n')),(0,o.kt)("p",null,"As ",(0,o.kt)("inlineCode",{parentName:"p"},"expireAfter")," was set to 0, the document will count as expired when wall clock time has reached the timeout."),(0,o.kt)("p",null,"It should be intuitive to see that the ",(0,o.kt)("inlineCode",{parentName:"p"},"expireDate")," can be different per document. This allows mixing of documents with different expiration periods by calculating their expiration dates differently in the client application."),(0,o.kt)("h3",{id:"format-of-datetime-values"},"Format of date/time values"),(0,o.kt)("p",null,"The expiration date time values can be specified either as a numeric timestamp, containing the number of milliseconds since January 1st 1970 (rounded down to the nearest second), or as a date/time string in ISO 8601 format ",(0,o.kt)("inlineCode",{parentName:"p"},"YYYY-MM-DDTHH:MM:SS")," with an optional timezone offset. The timezone offset can be specified as either ",(0,o.kt)("inlineCode",{parentName:"p"},"Z")," (Zulu/UTC time) or as a deviation from UTC time in hours and minutes (i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"+HH:MM")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"-HH:MM"),")."),(0,o.kt)("p",null,"Valid example date string values are:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Date/time string"),(0,o.kt)("th",{parentName:"tr",align:null},"Local Date"),(0,o.kt)("th",{parentName:"tr",align:null},"Local Time"),(0,o.kt)("th",{parentName:"tr",align:null},"Timezone Offset"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"00:00:00"),(0,o.kt)("td",{parentName:"tr",align:null},"+00:00 (UTC time)")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27T21:20:00"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"21:20:00"),(0,o.kt)("td",{parentName:"tr",align:null},"+00:00 (UTC time)")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27T21:20:00Z"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"21:20:00"),(0,o.kt)("td",{parentName:"tr",align:null},"+00:00 (UTC time)")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27T21:20:00.123Z"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"21:20:00.123"),(0,o.kt)("td",{parentName:"tr",align:null},"+00:00 (UTC time)")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27T21:20:00.123+01:30"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"21:20:00.123"),(0,o.kt)("td",{parentName:"tr",align:null},"+01:30 offset from UTC time")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("inlineCode",{parentName:"td"},'"2019-05-27T21:20:00.123-02:00"')),(0,o.kt)("td",{parentName:"tr",align:null},"May 27th 2019"),(0,o.kt)("td",{parentName:"tr",align:null},"21:20:00.123"),(0,o.kt)("td",{parentName:"tr",align:null},"-02:00 offset from UTC time")))),(0,o.kt)("p",null,"Using an invalid date string value in a document's TTL index attribute will prevent the document from being inserted into the TTL index, so it will neither be expired nor removed automatically. No error is raised however."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Date string values can be programmatically validated using the AQL function ",(0,o.kt)("inlineCode",{parentName:"p"},"IS_DATESTRING"),"."))),(0,o.kt)("h3",{id:"preventing-documents-from-being-removed"},"Preventing documents from being removed"),(0,o.kt)("p",null,"In case the index attribute does not contain a numeric value nor a proper date string, the document will not be stored in the TTL index and thus will not become a candidate for expiration and removal. Providing either a non-numeric value or even no value for the index attribute is a supported way to keep documents from being expired and removed."),(0,o.kt)("h3",{id:"limitations"},"Limitations"),(0,o.kt)("p",null,"TTL indexes are designed exactly for the purpose of removing expired documents from collections. It is ",(0,o.kt)("strong",{parentName:"p"},"not recommended")," to rely on TTL indexes for user-land C8QL queries. This is because TTL indexes may store a transformed, always numerical version of the index attribute value internally even if it was originally passed in as a date string. As a result, you may see different values for the attribute, depending on whether it gets taken from the index or the document. TTL indexes will likely not be usable for filtering and sort operations in user-land C8QL queries."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"There can at most be one TTL index per collection.")),(0,o.kt)("p",null,"The actual removal of expired documents will not necessarily happen immediately when they have reached their expiration time. "),(0,o.kt)("p",null,"Expired documents will eventually be removed by a background thread that is periodically going through all TTL indexes and removing the expired documents."),(0,o.kt)("p",null,"There is no guarantee when exactly the removal of expired documents will be carried out, so queries may still find and return documents that have already expired. These will eventually be removed when the background thread kicks in and has spare capacity to remove the expired documents. It is guaranteed however that only documents which are past their expiration time will actually be removed."),(0,o.kt)("p",null,"The frequency for invoking the background removal thread can be configured using the ",(0,o.kt)("inlineCode",{parentName:"p"},"--ttl.frequency")," startup option. The frequency is specified in milliseconds."),(0,o.kt)("p",null,'In order to avoid "random" load spikes by the background thread suddenly kicking in and removing a lot of documents at once, the number of to-be-removed documents per thread invocation can be capped.'),(0,o.kt)("p",null,"The total maximum number of documents to be removed per thread invocation is controlled by the startup option ",(0,o.kt)("inlineCode",{parentName:"p"},"--ttl.max-total-removes"),". The maximum number of documents in a single collection at once can be controlled by the startup option ",(0,o.kt)("inlineCode",{parentName:"p"},"--ttl.max-collection-removes"),"."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"There are limited number of background threads for performing the removal of expired documents of all collections in all databases. If the number of databases and collections with TTL indexes is high and there are many documents to remove from these, the background thread may at least temporarily lag behind with its removal operations. It should eventually catch up in case the number of to-be-removed documents per invocation is not higher than the background thread's configured threshold values."))),(0,o.kt)("h3",{id:"accessing-ttl-indexes"},"Accessing TTL Indexes"),(0,o.kt)("p",null,"Ensures that a TTL index exists:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "ttl", fields: [ "field" ], expireAfter: 600 })')),(0,o.kt)("p",null,"Creates a TTL index on all documents using ",(0,o.kt)("em",{parentName:"p"},"field")," as attribute path. Exactly one attribute path has to be given. The index will be sparse in all cases."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("h2",{id:"fulltext-indexes"},"Fulltext Indexes"),(0,o.kt)("h3",{id:"introduction-2"},"Introduction"),(0,o.kt)("p",null,"A fulltext index can be used to find words, or prefixes of words inside documents."),(0,o.kt)("p",null,"A fulltext index can be defined on one attribute only, and will include all words contained in documents that have a textual value in the index attribute."),(0,o.kt)("p",null,"For example, given a fulltext index on the ",(0,o.kt)("inlineCode",{parentName:"p"},"translations")," attribute and the following documents, then searching for ",(0,o.kt)("inlineCode",{parentName:"p"},"\u043b\u0438\u0441\u0430")," using the fulltext index would return only the first document. Searching for the index for the exact string ",(0,o.kt)("inlineCode",{parentName:"p"},"Fox")," would return the first two documents, and searching for ",(0,o.kt)("inlineCode",{parentName:"p"},"prefix:Fox")," would return all three documents:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{ translations: { en: "fox", de: "Fuchs", fr: "renard", ru: "\u043b\u0438\u0441\u0430" } }\n{ translations: "Fox is the English translation of the German word Fuchs" }\n{ translations: [ "C8DB", "document", "database", "Fox" ] }\n')),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Deeper nested objects are ignored. For example, a fulltext index on ",(0,o.kt)("em",{parentName:"p"},"translations")," would index ",(0,o.kt)("em",{parentName:"p"},"Fuchs"),", but not ",(0,o.kt)("em",{parentName:"p"},"fox"),", given the following document structure:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'{ translations: { en: { US: "fox" }, de: "Fuchs" }\n')),(0,o.kt)("p",null,"If you need to search across multiple fields and/or nested objects, you may write all the strings into a special attribute, which you then create the index on (it might be necessary to clean the strings first, e.g. remove line breaks and strip certain words)."),(0,o.kt)("p",null,"If the index attribute is neither a string, an object or an array, its contents will not be indexed. When indexing the contents of an array attribute, an array member will only be included in the index if it is a string. When indexing the contents of an object attribute, an object member value will only be included in the index if it is a string. Other data types are ignored and not indexed."),(0,o.kt)("h3",{id:"accessing-fulltext-indexes"},"Accessing Fulltext Indexes"),(0,o.kt)("p",null,"Ensures that a fulltext index exists:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "fulltext", fields: [ "field" ], minLength: minLength })')),(0,o.kt)("p",null,"Creates a fulltext index on all documents on attribute ",(0,o.kt)("em",{parentName:"p"},"field"),"."),(0,o.kt)("p",null,"Fulltext indexes are implicitly sparse: all documents which do not have the specified ",(0,o.kt)("em",{parentName:"p"},"field")," attribute or that have a non-qualifying value in their ",(0,o.kt)("em",{parentName:"p"},"field")," attribute will be ignored for indexing."),(0,o.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Only a single attribute can be indexed. Specifying multiple attributes is unsupported."))),(0,o.kt)("p",null,"The minimum length of words that are indexed can be specified via the ",(0,o.kt)("em",{parentName:"p"},"minLength")," parameter. Words shorter than minLength characters will not be indexed. ",(0,o.kt)("em",{parentName:"p"},"minLength")," has a default value of 2. It is thus recommended to explicitly specify this value."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details is returned."),(0,o.kt)("p",null,"Looks up a fulltext index:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"collection.lookupFulltextIndex(attribute, minLength)")),(0,o.kt)("p",null,"Checks whether a fulltext index on the given attribute ",(0,o.kt)("em",{parentName:"p"},"attribute")," exists."),(0,o.kt)("h3",{id:"fulltext-c8ql-functions"},"Fulltext C8QL Functions"),(0,o.kt)("p",null,"Fulltext C8QL functions are detailed in ",(0,o.kt)("a",{parentName:"p",href:"/docs/c8ql/functions/fulltext"},"Fulltext functions"),"."),(0,o.kt)("h2",{id:"geo-spatial-indexes"},"Geo-Spatial Indexes"),(0,o.kt)("p",null,"GDN features ",(0,o.kt)("a",{parentName:"p",href:"http://s2geometry.io/"},"Google S2"),'{:target="_blank"} based geospatial index. Indexing is supported for a subset of the ',(0,o.kt)("a",{parentName:"p",href:"#geojson"},(0,o.kt)("strong",{parentName:"a"},"GeoJSON"))," geometry types as well as simple latitude longitude pairs."),(0,o.kt)("p",null,"C8QL's geospatial functions and GeoJSON constructors are described in ",(0,o.kt)("a",{parentName:"p",href:"/docs/collections/documents/indexing/working-with-indexes"},"Geo functions"),"."),(0,o.kt)("p",null,"The geospatial index supports containment and intersection queries for various geometric 2D shapes. You should be mainly using AQL queries to perform these types of operations. The index can operate in ",(0,o.kt)("strong",{parentName:"p"},"two different modes"),", depending on if you want to use the GeoJSON data-format or not. The modes are mainly toggled by using the ",(0,o.kt)("inlineCode",{parentName:"p"},"geoJson")," field when creating the index."),(0,o.kt)("p",null,"This index assumes coordinates with the latitude between -90 and 90 degrees and the longitude between -180 and 180 degrees. A geo index will ignore all documents which do not fulfill these requirements."),(0,o.kt)("h3",{id:"geojson-mode"},"GeoJSON Mode"),(0,o.kt)("p",null,"To create an index in GeoJSON mode execute:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'collection.ensureIndex({ type: "geo", fields: [ "geometry" ], geoJson:true })\n')),(0,o.kt)("p",null,"This creates the index on all documents and uses ",(0,o.kt)("em",{parentName:"p"},"geometry")," as the attributed field where the value is either a ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1"},"Geometry Object"),'{:target="',(0,o.kt)("em",{parentName:"p"},'blank"} ',(0,o.kt)("strong",{parentName:"em"},"or")," a _coordinate array"),". "),(0,o.kt)("p",null,"The array must contain at least two numeric values with longitude (first value) and the latitude (second value). This corresponds to the format described in ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.1"},"RFC 7946 Position"),'{:target="_blank"}.'),(0,o.kt)("p",null,"All documents, which do not have the attribute path or have a non-conform value in it, are excluded from the index."),(0,o.kt)("p",null,"A geo index is implicitly sparse, and there is no way to control its sparsity. In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("h3",{id:"non-geojson-mode"},"Non-GeoJSON mode"),(0,o.kt)("p",null,"This index mode exclusively supports indexing on coordinate arrays. Values that contain GeoJSON or other types of data will be ignored. In the non-GeoJSON mode the index can be created on one or two fields."),(0,o.kt)("p",null,"To create a geo-spatial index on all documents using ",(0,o.kt)("em",{parentName:"p"},"latitude")," and ",(0,o.kt)("em",{parentName:"p"},"longitude")," as separate attribute paths, two paths need to be specified in the ",(0,o.kt)("em",{parentName:"p"},"fields")," array:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "latitude", "longitude" ] })')),(0,o.kt)("p",null,"The first field is always defined to be the ",(0,o.kt)("em",{parentName:"p"},"latitude")," and the second is the ",(0,o.kt)("em",{parentName:"p"},"longitude"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"geoJson")," flag is implicitly ",(0,o.kt)("em",{parentName:"p"},"false")," in this mode."),(0,o.kt)("p",null,"Alternatively you can specify only one field:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "location" ], geoJson:false })')),(0,o.kt)("p",null,"It creates a geospatial index on all documents using ",(0,o.kt)("em",{parentName:"p"},"location")," as the path to the coordinates. The value of the attribute has to be an array with at least two numeric values. The array must contain the latitude (first value) and the longitude (second value)."),(0,o.kt)("p",null,"All documents, which do not have the attribute path(s) or have a non-conforming value in it, are excluded from the index."),(0,o.kt)("p",null,"A geo index is implicitly sparse, and there is no way to control its sparsity. In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("h3",{id:"indexed-geospatial-queries"},"Indexed GeoSpatial Queries"),(0,o.kt)("p",null,"The geospatial index supports a variety of C8QL queries, which can be built with the help of the ",(0,o.kt)("a",{parentName:"p",href:"/docs/collections/documents/indexing/working-with-indexes"},"geo utility functions"),". There are three specific geo functions that can be optimized, provided that they are used correctly: ",(0,o.kt)("inlineCode",{parentName:"p"},"GEO_DISTANCE, GEO_CONTAINS, GEO_INTERSECTS"),". Additionally, there is a built-in support to optimize the older geo functions ",(0,o.kt)("inlineCode",{parentName:"p"},"DISTANCE"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"NEAR")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"WITHIN")," (the last two only if they are used in their 4 argument version, without ",(0,o.kt)("em",{parentName:"p"},"distanceName"),")."),(0,o.kt)("p",null,"When in doubt whether your query is being properly optimized, check the ",(0,o.kt)("a",{parentName:"p",href:"/docs/collections/documents/indexing/working-with-indexes"},"C8QL explain")," output to check for index usage."),(0,o.kt)("h4",{id:"query-for-results-near-origin-near-type-query"},"Query for Results near Origin (NEAR type query)"),(0,o.kt)("p",null,"A basic example of a query for results near an origin point:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"FOR x IN geo_collection\n  FILTER GEO_DISTANCE([@lng, @lat], x.geometry) <= 100000\n  RETURN x._key\n")),(0,o.kt)("p",null,"The first parameter can be a GeoJSON object or a coordinate array in ",(0,o.kt)("inlineCode",{parentName:"p"},"[longitude, latitude]")," ordering. The second parameter is the document field on which the index was created. The function ",(0,o.kt)("inlineCode",{parentName:"p"},"GEO_DISTANCE")," always returns the distance in meters, so will receive results up until ",(0,o.kt)("em",{parentName:"p"},"100km"),"."),(0,o.kt)("h4",{id:"query-for-sorted-results-near-origin-near-type-query"},"Query for Sorted Results near Origin (NEAR type query)"),(0,o.kt)("p",null,"A basic example of a query for the 1000 nearest results to an origin point (ascending sorting):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"FOR x IN geo_collection\n  SORT GEO_DISTANCE([@lng, @lat], x.geometry) ASC\n  LIMIT 1000\n  RETURN x._key\n")),(0,o.kt)("p",null,"The first parameter can be a GeoJSON object or a coordinate array in ",(0,o.kt)("inlineCode",{parentName:"p"},"[longitude, latitude]")," ordering. The second parameter is the documents field on which the index was created."),(0,o.kt)("p",null,"You may also get results farthest away (distance sorted in descending order):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"FOR x IN geo_collection\n  SORT GEO_DISTANCE([@lng, @lat], x.geometry) DESC\n  LIMIT 1000\n  RETURN x._key\n")),(0,o.kt)("h4",{id:"query-for-results-within-distance"},"Query for Results within Distance"),(0,o.kt)("p",null,"A query which returns documents at a distance of ",(0,o.kt)("em",{parentName:"p"},"1km")," or farther away, up to ",(0,o.kt)("em",{parentName:"p"},"100km")," from the origin. This will return the documents with a GeoJSON value that is located in the specified search annulus."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"FOR x IN geo_collection\n  FILTER GEO_DISTANCE([@lng, @lat], x.geometry) <= 100000\n  FILTER GEO_DISTANCE([@lng, @lat], x.geometry) >= 1000\n  RETURN x\n")),(0,o.kt)("h4",{id:"query-for-results-contained-in-polygon"},"Query for Results contained in Polygon"),(0,o.kt)("p",null,"A query which returns documents whose stored geometry is contained within a GeoJSON Polygon."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"LET polygon = GEO_POLYGON([[[60,35],[50,5],[75,10],[70,35]]])\nFOR x IN geo_collection\n  FILTER GEO_CONTAINS(polygon, x.geometry)\n  RETURN x\n")),(0,o.kt)("p",null,"The first parameter of ",(0,o.kt)("inlineCode",{parentName:"p"},"GEO_CONTAINS")," must be a polygon. Other types are not valid. The second parameter must contain the document field on which the index was created."),(0,o.kt)("h4",{id:"query-for-results-intersecting-a-polygon"},"Query for Results Intersecting a Polygon"),(0,o.kt)("p",null,"A query which returns documents with an intersection of their stored geometry and a GeoJSON Polygon."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"LET polygon = GEO_POLYGON([[[60,35],[50,5],[75,10],[70,35]]])\nFOR x IN geo_collection\n  FILTER GEO_INTERSECTS(polygon, x.geometry)\n  RETURN x\n")),(0,o.kt)("p",null,"The first parameter of ",(0,o.kt)("inlineCode",{parentName:"p"},"GEO_INTERSECTS")," must be a polygon. Other types are not valid. The second parameter must contain the document field on which the index was created."),(0,o.kt)("h3",{id:"geojson"},"GeoJSON"),(0,o.kt)("p",null,"GeoJSON is a geospatial data format based on JSON. It defines several different types of JSON objects and the way in which they can be combined to represent data about geographic shapes on the earth surface. GeoJSON uses a geographic coordinate reference system, World Geodetic System 1984 (WGS 84), and units of decimal degrees."),(0,o.kt)("p",null,"Internally GDN maps all coordinates onto a unit sphere. Distances are projected onto a sphere with the Earth's ",(0,o.kt)("em",{parentName:"p"},"Volumetric mean radius")," of ",(0,o.kt)("em",{parentName:"p"},"6371 km"),". GDN implements a useful subset of the GeoJSON format ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946"},"(RFC 7946)"),'{:target="_blank"}. Feature Objects and the GeometryCollection type are not supported. '),(0,o.kt)("p",null,"Supported geometry object types are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Point"),(0,o.kt)("li",{parentName:"ul"},"MultiPoint"),(0,o.kt)("li",{parentName:"ul"},"LineString"),(0,o.kt)("li",{parentName:"ul"},"MultiLineString"),(0,o.kt)("li",{parentName:"ul"},"Polygon")),(0,o.kt)("h4",{id:"point"},"Point"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.2"},"GeoJSON Point"),'{:target="_blank"} is a ',(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.1"},"position"),'{:target="_blank"} comprised of a longitude and a latitude:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "Point",\n  "coordinates": [100.0, 0.0]\n}\n')),(0,o.kt)("h4",{id:"multipoint"},"MultiPoint"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.7"},"GeoJSON MultiPoint"),'{:target="_blank"} is an array of positions:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "MultiPoint",\n  "coordinates": [\n    [100.0, 0.0],\n    [101.0, 1.0]\n  ]\n}\n')),(0,o.kt)("h4",{id:"linestring"},"LineString"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.4"},"GeoJSON LineString"),'{:target="_blank"} is an array of two or more positions:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "LineString",\n  "coordinates": [\n    [100.0, 0.0],\n    [101.0, 1.0]\n  ]\n}\n')),(0,o.kt)("h4",{id:"multilinestring"},"MultiLineString"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.5"},"GeoJSON MultiLineString"),'{:target="_blank"} is an array of LineString coordinate arrays:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "MultiLineString",\n  "coordinates": [\n    [\n      [100.0, 0.0],\n      [101.0, 1.0]\n    ],\n    [\n      [102.0, 2.0],\n      [103.0, 3.0]\n    ]\n  ]\n}\n')),(0,o.kt)("h4",{id:"polygon"},"Polygon"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.6"},"GeoJSON Polygon"),'{:target="_blank"} consists of a series of closed ',(0,o.kt)("inlineCode",{parentName:"p"},"LineString")," objects (ring-like). These ",(0,o.kt)("em",{parentName:"p"},"Linear Ring")," objects consist of four or more vertices with the first and last coordinate pairs being equal. Coordinates of a Polygon are an array of linear ring coordinate arrays. The first element in the array represents the exterior ring."),(0,o.kt)("p",null,"Any subsequent elements represent interior rings (holes within the surface)."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"A linear ring may not be empty, it needs at least three ",(0,o.kt)("em",{parentName:"li"},"distinct")," coordinates"),(0,o.kt)("li",{parentName:"ul"},"Within the same linear ring consecutive coordinates may be the same, otherwise (except the first and last one) all coordinates need to be distinct"),(0,o.kt)("li",{parentName:"ul"},"A linear ring defines two regions on the sphere. GDN will always interpret the region of smaller area to be the interior of the ring. This introduces a practical limitation that no polygon may have an outer ring enclosing more than half the Earth's surface")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"No Holes:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "Polygon",\n    "coordinates": [\n    [\n      [100.0, 0.0],\n      [101.0, 0.0],\n      [101.0, 1.0],\n      [100.0, 1.0],\n      [100.0, 0.0]\n    ]\n  ]\n}\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"With Holes:")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The exterior ring should not self-intersect."),(0,o.kt)("li",{parentName:"ul"},"The interior rings must be contained in the outer ring"),(0,o.kt)("li",{parentName:"ul"},"No two rings can cross each other, i.e. no ring may intersect both the interior and exterior face of another ring"),(0,o.kt)("li",{parentName:"ul"},"Rings cannot share edges, they may however share vertices"),(0,o.kt)("li",{parentName:"ul"},"No ring may be empty"),(0,o.kt)("li",{parentName:"ul"},"Polygon rings should follow the right-hand rule for orientation (counterclockwise external rings, clockwise internal rings).")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "Polygon",\n  "coordinates": [\n    [\n      [100.0, 0.0],\n      [101.0, 0.0],\n      [101.0, 1.0],\n      [100.0, 1.0],\n      [100.0, 0.0]\n    ],\n    [\n      [100.8, 0.8],\n      [100.8, 0.2],\n      [100.2, 0.2],\n      [100.2, 0.8],\n      [100.8, 0.8]\n    ]\n  ]\n}\n')),(0,o.kt)("h4",{id:"multipolygon"},"MultiPolygon"),(0,o.kt)("p",null,"A ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.6"},"GeoJSON MultiPolygon"),'{:target="',(0,o.kt)("em",{parentName:"p"},'blank"} consists of multiple polygons. The "coordinates" member is an array of _Polygon')," coordinate arrays. "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Polygons in the same MultiPolygon may not share edges, they may share coordinates"),(0,o.kt)("li",{parentName:"ul"},"Polygons and rings must not be empty"),(0,o.kt)("li",{parentName:"ul"},"A linear ring defines two regions on the sphere. GDN will always interpret the region of smaller area to be the interior of the ring. This introduces a practical limitation that no polygon may have an outer ring enclosing more than half the Earth's surface"),(0,o.kt)("li",{parentName:"ul"},"Linear rings ",(0,o.kt)("strong",{parentName:"li"},"must")," follow the right-hand rule for orientation (counterclockwise external rings, clockwise internal rings).")),(0,o.kt)("p",null,"Example with two polygons, the second one with a hole:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "type": "MultiPolygon",\n    "coordinates": [\n        [\n            [\n                [102.0, 2.0],\n                [103.0, 2.0],\n                [103.0, 3.0],\n                [102.0, 3.0],\n                [102.0, 2.0]\n            ]\n        ],\n        [\n            [\n                [100.0, 0.0],\n                [101.0, 0.0],\n                [101.0, 1.0],\n                [100.0, 1.0],\n                [100.0, 0.0]\n            ],\n            [\n                [100.2, 0.2],\n                [100.2, 0.8],\n                [100.8, 0.8],\n                [100.8, 0.2],\n                [100.2, 0.2]\n            ]\n        ]\n    ]\n}\n')),(0,o.kt)("h4",{id:"examples"},"Examples"),(0,o.kt)("p",null,"ensures that a geo index exists\n",(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "location" ] })')),(0,o.kt)("p",null,"Creates a geospatial index on all documents using ",(0,o.kt)("em",{parentName:"p"},"location")," as the path to the coordinates. The value of the attribute has to be an array with at least two numeric values. The array must contain the latitude (first value) and the longitude (second value)."),(0,o.kt)("p",null,"All documents, which do not have the attribute path or have a non-conforming value in it, are excluded from the index."),(0,o.kt)("p",null,"A geo index is implicitly sparse, and there is no way to control its sparsity."),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("p",null,"To create a geo index on an array attribute that contains longitude first, set the ",(0,o.kt)("em",{parentName:"p"},"geoJson")," attribute to ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),". This corresponds to the format described in ",(0,o.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc7946#section-3.1.1"},"RFC 7946 Position"),'{:target="_blank"}'),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "location" ], geoJson: true })')),(0,o.kt)("p",null,"To create a geo-spatial index on all documents using ",(0,o.kt)("em",{parentName:"p"},"latitude")," and ",(0,o.kt)("em",{parentName:"p"},"longitude")," as separate attribute paths, two paths need to be specified in the ",(0,o.kt)("em",{parentName:"p"},"fields")," array:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "latitude", "longitude" ] })')),(0,o.kt)("p",null,"In case that the index was successfully created, an object with the index details, including the index-identifier, is returned."),(0,o.kt)("p",null,"ensures that a geo index exists\n",(0,o.kt)("inlineCode",{parentName:"p"},'collection.ensureIndex({ type: "geo", fields: [ "location" ] })')),(0,o.kt)("p",null,"This method is an alias for ",(0,o.kt)("em",{parentName:"p"},"ensureGeoIndex")," since geo indexes are always sparse, meaning that documents that do not contain the index attributes or has non-numeric values in the index attributes will not be indexed. ",(0,o.kt)("em",{parentName:"p"},"ensureGeoConstraint")," is deprecated and ",(0,o.kt)("em",{parentName:"p"},"ensureGeoIndex")," should be used instead."),(0,o.kt)("p",null,"The index does not provide a ",(0,o.kt)("inlineCode",{parentName:"p"},"unique")," option because of its limited usability. It would prevent identical coordinates from being inserted only, but even a slightly different location (like 1 inch or 1 cm off) would be unique again and not considered a duplicate, although it probably should. The desired threshold for detecting duplicates may vary for every project (including how to calculate the distance even) and needs to be implemented on the application layer as needed. "),(0,o.kt)("h2",{id:"vertex-centric-indexes"},"Vertex centric indexes"),(0,o.kt)("p",null,"As mentioned above, the most important indexes for graphs are the edge indexes, indexing the ",(0,o.kt)("inlineCode",{parentName:"p"},"_from")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"_to")," attributes of edge collections. They provide very quick access to all edges originating in or arriving at a given vertex, which allows to quickly find all neighbours of a vertex in a graph."),(0,o.kt)("p",null,'In many cases one would like to run more specific queries, for example finding amongst the edges originating in a given vertex only those with the 20 latest time stamps. Exactly this is achieved with "vertex centric indexes". In a sense these are localized indexes for an edge collection, which sit at every single vertex.'),(0,o.kt)("p",null,"Technically, they are implemented in GDN as indexes, which sort the complete edge collection first by ",(0,o.kt)("inlineCode",{parentName:"p"},"_from")," and then by other attributes. If we for example have a skiplist index on the attributes ",(0,o.kt)("inlineCode",{parentName:"p"},"_from")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"timestamp")," of an edge collection, we can answer the above question very quickly with a single range lookup in the index."),(0,o.kt)("p",null,'One can create sorted indexes (type "skiplist" and "persistent") that index the special edge attributes ',(0,o.kt)("inlineCode",{parentName:"p"},"_from")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"_to")," and additionally other attributes. These are used in graph traversals, when appropriate ",(0,o.kt)("inlineCode",{parentName:"p"},"FILTER")," statements are found by the optimizer."),(0,o.kt)("p",null,"For example, to create a vertex centric index of the above type, you would simply do"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'edges.ensureIndex({"type":"skiplist", "fields": ["_from", "timestamp"]});\n')),(0,o.kt)("p",null,"Then, queries like"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'FOR v, e, p IN 1..1 OUTBOUND "V/1" edges\n  FILTER e.timestamp ALL >= "2016-11-09"\n  RETURN p\n')),(0,o.kt)("p",null,"will be considerably faster in case there are many edges originating in vertex ",(0,o.kt)("inlineCode",{parentName:"p"},'"V/1"')," but only few with a recent time stamp."),(0,o.kt)("h2",{id:"index-identifiers--handles"},"Index Identifiers & Handles"),(0,o.kt)("p",null,"An ",(0,o.kt)("inlineCode",{parentName:"p"},"index handle")," uniquely identifies an index in the database. It is a string and consists of the collection name and an ",(0,o.kt)("inlineCode",{parentName:"p"},"index identifier")," separated by a ",(0,o.kt)("inlineCode",{parentName:"p"},"/"),". The index identifier part is a numeric value that is auto-generated by GDN."),(0,o.kt)("p",null,"A specific index of a collection can be accessed using its ",(0,o.kt)("em",{parentName:"p"},"index handle")," or ",(0,o.kt)("em",{parentName:"p"},"index identifier")," as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'collection.index("<index-handle>");\ncollection.index("<index-identifier>");\n_index("<index-handle>");\n')),(0,o.kt)("p",null,"For example: Assume that the index handle, which is stored in the ",(0,o.kt)("inlineCode",{parentName:"p"},"_id")," attribute of the index, is ",(0,o.kt)("inlineCode",{parentName:"p"},"demo/362549736")," and the index was created in a collection named ",(0,o.kt)("inlineCode",{parentName:"p"},"demo"),". Then this index can be accessed as:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'demo.index("demo/362549736");\n')),(0,o.kt)("p",null,"Because the index handle is unique within the database, you can leave out the ",(0,o.kt)("em",{parentName:"p"},"collection")," and use the shortcut:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'_index("demo/362549736");\n')),(0,o.kt)("h2",{id:"collection-methods"},"Collection Methods"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Listing all indexes of a collection:")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"getIndexes()")," -  returns information about the indexes"),(0,o.kt)("p",null,"Returns an array of all indexes defined for the collection. Note that ",(0,o.kt)("inlineCode",{parentName:"p"},"_key")," implicitly has an index assigned to it."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Creating an index:")),(0,o.kt)("p",null,"Indexes should be created using the general method ",(0,o.kt)("inlineCode",{parentName:"p"},"ensureIndex"),". "),(0,o.kt)("p",null,"ensures that an index exists\n",(0,o.kt)("inlineCode",{parentName:"p"},"collection.ensureIndex(index-description)")),(0,o.kt)("p",null,"Ensures that an index according to the ",(0,o.kt)("inlineCode",{parentName:"p"},"index-description")," exists. A new index will be created if none exists with the given description."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"index-description")," must contain at least a ",(0,o.kt)("inlineCode",{parentName:"p"},"type")," attribute. Other attributes may be necessary, depending on the index type."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"type")," can be one of the following values:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"hash"),": hash index"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"skiplist"),": skiplist index"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"fulltext"),": fulltext index"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"geo"),": geo index, with one or two attributes")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"name")," can be a string. Index names are subject to the same character restrictions as collection names. If omitted, a name will be auto-generated so that it is unique with respect to the collection, e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"idx_832910498"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"sparse")," can be ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,o.kt)("p",null,"For ",(0,o.kt)("inlineCode",{parentName:"p"},"hash"),", and *",(0,o.kt)("inlineCode",{parentName:"p"},"skiplist")," the sparsity can be controlled, ",(0,o.kt)("inlineCode",{parentName:"p"},"fulltext")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"geo")," are ",(0,o.kt)("a",{parentName:"p",href:"/docs/collections/documents/indexing/which-index"},"sparse")," by definition."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"unique")," can be ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"false")," and is supported by ",(0,o.kt)("inlineCode",{parentName:"p"},"hash")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"skiplist")),(0,o.kt)("p",null,"Calling this method returns an index object. Whether or not the index object existed before the call is indicated in the return attribute ",(0,o.kt)("em",{parentName:"p"},"isNewlyCreated"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"deduplicate")," can be ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"false")," and is supported by array indexes of type ",(0,o.kt)("inlineCode",{parentName:"p"},"hash")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"skiplist"),". It controls whether inserting duplicate index values from the same document into a unique array index will lead to a unique constraint error or not. The default value is ",(0,o.kt)("inlineCode",{parentName:"p"},"true"),", so only a single instance of each non-unique index value will be inserted into the index per document. Trying to insert a value into the index that already exists in the index will always fail, regardless of the value of this attribute."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Examples")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'test.ensureIndex({ type: "hash", fields: [ "a" ], sparse: true });\ntest.ensureIndex({ type: "hash", fields: [ "a", "b" ], unique: true });\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Dropping an index:")),(0,o.kt)("p",null,"drops an index ",(0,o.kt)("inlineCode",{parentName:"p"},"collection.dropIndex(index)")),(0,o.kt)("p",null,"Drops the index. If the index does not exist, then ",(0,o.kt)("inlineCode",{parentName:"p"},"false")," is returned. If the index existed and was dropped, then ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," is returned. Note that you cannot drop some special indexes (e.g. the primary index of a collection or the edge index of an edge collection)."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"collection.dropIndex(index-handle)")),(0,o.kt)("p",null,"Same as above. Instead of an index an index handle can be given."),(0,o.kt)("h2",{id:"geofabric-methods"},"GeoFabric Methods"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Fetching an index by handle")),(0,o.kt)("p",null,"finds an index ",(0,o.kt)("inlineCode",{parentName:"p"},"_index(index-handle)")),(0,o.kt)("p",null,"Returns the index with ",(0,o.kt)("inlineCode",{parentName:"p"},"index-handle")," or null if no such index exists."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Dropping an index:")),(0,o.kt)("p",null,"drops an index\n",(0,o.kt)("inlineCode",{parentName:"p"},"_dropIndex(index)")),(0,o.kt)("p",null,"Drops the ",(0,o.kt)("inlineCode",{parentName:"p"},"index"),".  If the index does not exist, then ",(0,o.kt)("inlineCode",{parentName:"p"},"false")," is returned. If the index existed and was dropped, then ",(0,o.kt)("inlineCode",{parentName:"p"},"true")," is returned."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"_dropIndex(index-handle)")),(0,o.kt)("p",null,"Drops the index with ",(0,o.kt)("inlineCode",{parentName:"p"},"index-handle"),"."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Revalidating whether an index is used:")),(0,o.kt)("p",null,"finds an index"),(0,o.kt)("p",null,"So you've created an index, and since its maintainance isn't for free, you definitely want to know whether your query can utilize it."),(0,o.kt)("p",null,"You can use explain to verify whether ",(0,o.kt)("strong",{parentName:"p"},"skiplists")," or ",(0,o.kt)("strong",{parentName:"p"},"hash indexes")," are used."),(0,o.kt)("h2",{id:"creating-indexes-in-background"},"Creating Indexes in Background"),(0,o.kt)("p",null,'Creating new indexes is by default done under an exclusive collection lock. This means that the collection (or the respective shards) are not available for write operations as long as the index is created. This "foreground" index creation can be undesirable, if you have to perform it on a live system without a dedicated maintenance window.'),(0,o.kt)("p",null,'Indexes can also be created in "background", not using an exclusive lock during the entire index creation. The collection remains basically available, so that other CRUD operations can run on the collection while the index is being created. This can be achieved by setting the ',(0,o.kt)("em",{parentName:"p"},"inBackground")," attribute when creating an index."),(0,o.kt)("p",null,"To create an index in the background, just specify ",(0,o.kt)("inlineCode",{parentName:"p"},"inBackground: true"),", like in the following examples:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// create the hash index in the background\ncollection.ensureIndex({ type: "hash", fields: [ "value" ], unique: false, inBackground: true });\ncollection.ensureIndex({ type: "hash", fields: [ "email" ], unique: true, inBackground: true });\n\n// skiplist indexes work also of course\ncollection.ensureIndex({ type :"skiplist", fields: ["abc", "cdef"], unique: true, inBackground: true });\ncollection.ensureIndex({ type :"skiplist", fields: ["abc", "cdef"], sparse: true, inBackground: true });\n\n// also supported on fulltext indexes\ncollection.ensureIndex({ type: "geo", fields: [ "latitude", "longitude"], inBackground: true });\ncollection.ensureIndex({ type: "geo", fields: [ "latitude", "longitude"], inBackground: true });\ncollection.ensureIndex({ type: "fulltext", fields: [ "text" ], minLength: 4, inBackground: true })\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Behavior:")),(0,o.kt)("p",null,"Indexes that are still in the build process will not be visible via the GDN APIs. Nevertheless it is not possible to create the same index twice via the ",(0,o.kt)("em",{parentName:"p"},"ensureIndex")," API while an index is still begin created. AQL queries also will not use these indexes until the index reports back as fully created. Note that the initial ",(0,o.kt)("em",{parentName:"p"},"ensureIndex")," call or HTTP request will still block until the index is completely ready. Existing single-threaded client programs can thus safely set the ",(0,o.kt)("em",{parentName:"p"},"inBackground")," option to ",(0,o.kt)("em",{parentName:"p"},"true")," and continue to work as before."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Should you be building an index in the background you cannot rename or drop the collection. These operations will block until the index creation is finished. This is equally the case with foreground indexing."))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Performance:")),(0,o.kt)("p",null,'Background index creation might be slower than the "foreground" index creation and require more RAM. Under a write heavy load (specifically many remove, update or replace operations), the background index creation needs to keep a list of removed documents in RAM. This might become unsustainable if this list grows to tens of millions of entries.'),(0,o.kt)("p",null,"Building an index is always a write heavy operation (internally), it is always a good idea to build indexes during times with less load."),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"When in doubt about whether and which indexes will be used for executing a given C8QL query, click the ",(0,o.kt)("inlineCode",{parentName:"p"},"Explain")," button in the web interface in the ",(0,o.kt)("inlineCode",{parentName:"p"},"Queries")," view or use the ",(0,o.kt)("inlineCode",{parentName:"p"},"explain()")," method for the statement as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var query = "FOR doc IN collection FILTER doc.value > 42 RETURN doc";\nvar stmt = createStatement(query);\nstmt.explain();\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"explain()")," command will return a detailed JSON representation of the query's execution plan. The JSON explain output is intended to be used by code. To get a human-readable and much more compact explanation of the query, there is an explainer tool:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'var query = "FOR doc IN collection FILTER doc.value > 42 RETURN doc";\nrequire("@c8db_db/c8ql/explainer").explain(query);\n')),(0,o.kt)("p",null,"If any of the explain methods shows that a query is not using indexes, the following steps may help:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"check if the attribute names in the query are correctly spelled. In a schema-free database, documents in the same collection can have varying structures. There is no such thing as a ",(0,o.kt)("inlineCode",{parentName:"p"},"non-existing attribute")," error. A query that refers to attribute names not present in any of the documents will not return an error, and obviously will not benefit from indexes.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"check the return value of the ",(0,o.kt)("inlineCode",{parentName:"p"},"getIndexes()")," method for the collections used in the query and validate that indexes are actually present on the attributes used in the query's filter conditions. ")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"if indexes are present but not used by the query, the indexes may have the wrong type. For example, a hash index will only be used for equality comparisons (i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"=="),") but not for other comparison types such as ",(0,o.kt)("inlineCode",{parentName:"p"},"<"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"<="),", ",(0,o.kt)("inlineCode",{parentName:"p"},">"),", ",(0,o.kt)("inlineCode",{parentName:"p"},">="),". Additionally hash indexes will only be used if all of the index attributes are used in the query's FILTER conditions. A skiplist index will only be used if at least its first attribute is used in a FILTER condition. If additionally of the skiplist index attributes are specified in the query (from left-to-right), they may also be used and allow to filter more documents.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"using indexed attributes as function parameters or in arbitrary expressions will likely lead to the index on the attribute not being used. For example, the following queries will not use an index on ",(0,o.kt)("inlineCode",{parentName:"p"},"value"),":"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"      FOR doc IN collection FILTER TO_NUMBER(doc.value) == 42 RETURN doc\n      FOR doc IN collection FILTER doc.value - 1 == 42 RETURN doc\n")),(0,o.kt)("p",null,"  In these cases the queries should be rewritten so that only the index attribute is present on one side of the operator, or additional filters and indexes should be used to restrict the amount of documents otherwise."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"certain C8QL functions such as ",(0,o.kt)("inlineCode",{parentName:"p"},"WITHIN()")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"FULLTEXT()")," do utilize indexes internally, but their use is not mentioned in the query explanation for functions in general. These functions will raise query errors (at runtime) if no suitable index is present for the collection in question.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"the query optimizer will in general pick one index per collection in a query. It can pick more than one index per collection if the FILTER condition contains multiple branches combined with logical ",(0,o.kt)("inlineCode",{parentName:"p"},"OR"),".  For example, the following queries can use indexes:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"      FOR doc IN collection FILTER doc.value1 == 42 || doc.value1 == 23 RETURN doc\n      FOR doc IN collection FILTER doc.value1 == 42 || doc.value2 == 23 RETURN doc\n      FOR doc IN collection FILTER doc.value1 < 42 || doc.value2 > 23 RETURN doc\n")),(0,o.kt)("p",null,"  The two ",(0,o.kt)("inlineCode",{parentName:"p"},"OR"),"s in the first query will be converted to an ",(0,o.kt)("inlineCode",{parentName:"p"},"IN")," list, and if there is a suitable index on ",(0,o.kt)("inlineCode",{parentName:"p"},"value1"),", it will be used. The second query requires two separate indexes on ",(0,o.kt)("inlineCode",{parentName:"p"},"value1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"value2")," and will use them if present. The third query can use the indexes on ",(0,o.kt)("inlineCode",{parentName:"p"},"value1")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"value2")," when they are sorted."))}m.isMDXComponent=!0}}]);