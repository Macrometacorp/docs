---
sidebar_position: 10
title: Getting Started with Event Delivery
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

PhotonIQ Event Delivery is a fully managed service, implemented and optimized by Macrometa engineers to ensure proper functionality. For those who prefer a more hands-on approach, this guide provides information to help you actively manage Event Delivery.

In this guide, you'll learn how to:
- [Set up your first event stream in the PhotonIQ GDN](#setup-event-stream-in-the-photoniq-gdn)
- [Subscribe to events and recieve real time updates](#subscribe-to-events-and-recieve-real-time-updates)
- [Monitor the Event Delivery metrics and health stautus](#monitor-the-event-delivery-metrics-and-health-stautus)


The Event Delivery service enables you to stream and filter events from Macrometa [streams](../../streams/), as well as publish events to these streams. Before you proceed, here are some key concepts:

- **Publisher:** An application or service that continuously generates data for consumption by a subscriber. In the Event Delivery Service (EDS), collections in the Macrometa Global Data Network (GDN) act as publishers.
  
- **Subscriber:** An entity that subscribes to events from the publisher. Subscribers can use SQL-like queries to filter and subscribe to specific events, reducing noise and focusing on relevant data.
  
- **Stream:** A named channel for sending messages. Every stream in the GDN is backed by a distributed append-only log and can be either local (restricted to one edge location) or global (spanning all edge locations in the [fabric](../../geofabrics/)).
  
- **Event:** Each new data point or message generated by the publisher.


## Setup event stream in the PhotonIQ GDN

**Prerequisites**
- A Macrometa account with sufficient permissions to create [collections](../../collections/). You can contact a Macrometa partner to sign up or [sign up](https://www.macrometa.com/sign-up) on your own. Once your Macrometa account is set up, you can choose the type of collection to stream your data into. The PhotonIQ GDN offers the following options for EDS:
    - [Document Collection](../../collections/documents/index.md): Accepts any document type.
    - [Key-Value Collection](../../collections/keyvalue/index.md): Accepts key-value pairs and can be configured to include blobs.

:::tip

Consult your Macrometa partner to help decide the best type for your business use case.

:::

Now, proceed to set up your collection stream in the GDN following these steps:

1. [Create a Fabric](../../geofabrics/create-geofabric.md) for your collection to specify where your data resides. If you skip this step, the collection will be placed in the system fabric.
2. [Create a Collection](../../collections/index.md) to receive streaming data. For this guide, we'll be using [Document Collection](../../collections/documents/index.md).

![New Collection Stream](/img/photoniq/event-delivery/new-collection-stream.png)


:::important

Ensure you enable **Collection streams** and select a **Distribution** when creating the collection.

:::


3. Now that you've succesfully created a collection, add some data to that collection. Adding data to the collection depends on the type of [collection](../../collections/index.md) you created. 

- Navigate to the collection you created and click **New Document**
- Enter a key or leave empty for an auto-generated key.
- To add data to this document, toggle the **Tree** option to **Code** and add the following JSON:

```json
{
  "first_name": "Jenny",
  "service": "Executive",
  "attendance":4
}
```
- Click **Save**
- You can create multiple documents if you choose. Each of them will have a unique key.

You can also navigate to **Settings** to view more details about the collection.

## Subscribe to events and recieve real time updates

Once you've [set up your event collection stream](#setup-event-stream-in-the-photoniq-gdn), you can subscribe to the Event Delivery Service (EDS) to receive live updates using the [Event Delivery API](https://www.macrometa.com/docs/apiEds#/). 

### Subscribing to the EDS

[Subscribe to the stream](https://www.macrometa.com/docs/apiEds#/paths/ws:-api-es-v1-subscribe/get) by sending an API request. To subscribe to the stream, it requires the following fields:

- **EDS host**: The host where the EDS service is running.
- **x-customer-id**: The is used to authenticate the request.
- **filters**: Use filters to control the behaviour of your events and define the SQL queries to be executed. For example setting `initialDATA` to `TRUE` returns the original data after subscribing to a stream while a `FALSE` value only subscribes without returning the original data. The queries are SQL statements to get a specific subset of data from your collection. Refer to [Event Delivery Filters](event-delivery-filters.md) to learn more.

:::important

Contact your Macrometa partner for your EDS host and `x-customer-id`.

:::

In this sample guide, you'll be subscribing to the stream and fetching all the document in the collection where `attendance=4`.

<Tabs groupId="operating-systems">
<TabItem value="ws" label="WebSockets">

The endpoint  URL for subscribing to the stream via WebSocket follows this format:

```
wss://<eds-host>/api/es/v1/subscribe
```

:::important

Curl currently has no support for WebSockets, so we'll make this request using [wscat](https://github.com/WebSockets/wscat), a command line tool for establishing a connection and exchanging information with WebSockets.

:::

To send the susbcribe request with wscat, use this command:

```bash
wscat -c 'wss://<eds-host>/api/es/v1/subscribe?type=collection&x-customer-id=<x-customer-id>&filters={"action": "add", "once": "FALSE", "initialData":"TRUE", "queries": ["select * from <collection-name> where attendance=4"]}' | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
```
Replace the following:

- `<eds-host>` with your actual EDS host address.
- `<x-customer-id>` with your customer ID.
- `<collection-name>` with the name of the collection [you created earlier](#setup-event-stream-in-the-photoniq-gdn).

On sucessful subscription, the Websocket connection is created and the following information is included in the first response alongside the selected data from the collection:

- `x-photoniq-es`: Epoch time header. This is the Unix timestamp in seconds since epoch. It provides the epoch time in seconds.
- `x-photoniq-customerid`: Customer ID header. It is the customer identifier header.

:::note

The `sed` regex filter at the end removes any terminal color codes and control characters and can be ignored.

:::

</TabItem>

<TabItem value="sse" label="Server-Sent Event">
The endpoint  URL for subscribing to the stream via SSE follows this format:

```
https://<eds-host>/api/es/sse/v1/subscribe
```

To subscribe to the stream via SSE , use this curl command:

```bash
curl -X POST -H "Content-Type: application/json" -H "x-customer-id: <x-customer-id>" -d '{"type": "collection", "filters": {"once": "FALSE", "compress": "FALSE", "initialData":"TRUE", "queries": ["select * from <collection-name> where attendance=4"]}}' https://<eds-host>/api/es/sse/v1/subscribe
```

Replace the following:

- `<eds-host>` with your actual EDS host address.
- `<x-customer-id>` with your customer ID.
- `<collection-name>` with the name of the collection [you created earlier](#setup-event-stream-in-the-photoniq-gdn).

On sucessful subscription, the Websocket connection is created and the following information is included in the first response alongside the selected data from the collection:

- `x-photoniq-es`: Epoch time header. This is the Unix timestamp in seconds since epoch. It provides the epoch time in seconds.
- `x-photoniq-customerid`: Customer ID header. It is the customer identifier header.

</TabItem>
</Tabs>


Now that you've succesfully subscribed to the stream, the connection actively listens for any change made to the data.

### Receive real-time updates from subscribed streams

While the SSE or Websocket connection is open, all event updates for the subscribed collection are returned through the connection.

1. Go to the [Collection](#setup-event-stream-in-the-photoniq-gdn) and select any document data where `attendance=4`.
2. Toggle the **Tree** option to **Code** and change the `first_name` to Mark:

```json
{
  "attendance": 4,
  "first_name": "Mark",
  "service": "Executive"
}
```

The connection in the terminal immediately returns fresh data with the updated value of `Mark` as `first_name`.

### Publish Events to Data Stream
Unlike subscribing that occurs through a Websocket/SSE connection, publishing an event through the EDS occurs via HTTPS.
A sample publish event API call looks like this:

```shell
curl -X POST 'x/api/es/v1/fabric/<fabricName>/stream/<streamName>/publish?type=collection' -d '{"foo": "bar"}' -H x-customer-id=cust-edsgdn
```


## Monitor the Event Delivery metrics and health stautus
EDS offers numerous metrics for monitoring and evaluating the health status of your event service. Kindly refer to [Event Delivery Metrics and Health](event-delivery-metrics-and-health.md) for more details.






